<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>???</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.6.22/css/uikit.min.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.6.22/js/uikit.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3/dist/web3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.70.0/lib/index.iife.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.17.11/dist/js/uikit-icons.min.js"></script> 
    
    <link id="favicon" rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/5397/5397757.png">

    <script src="config.js"></script>
     <script src="main.js"></script>
    <style>
        .uk-container { width: 96%; max-width: none; }
        .status-active { color: green; }
        .status-inactive { color: red; }
        .sort-icon { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); }
        /* Memaksa warna link untuk CEX */
        .uk-link {
            color: inherit !important;  /* Memastikan warna link mengikuti warna induk */
        }
        a {
            text-decoration: none; /* Menghapus garis bawah */
            color: inherit;        /* Menggunakan warna teks elemen induk */
        }
        /* Memaksa warna status aktif */
        .status-active {
            color: inherit !important;  /* Warna aktif mengikuti warna yang ditentukan */
        }
        img:hover {
                opacity:1;
                transform: scale(1.8); /* You can adjust the scale factor as needed */
            }
        img{
            margin: 1.5px;
        }    
        #progress-container {
            width: 100%;
            background-color: #f3f3f3;
            border-radius: 10px;
            margin-top: 10px;  /* Ubah margin top menjadi lebih kecil */
        }

        #progress-bar {
            height: 14px;  /* Mengurangi tinggi bar progress menjadi 10px */
            width: 0%;
            /* background-color: #4caf50; */
            border-radius: 5px; /* Untuk membuat ujung bar lebih melengkung */
            position: relative;
        }

        #progress-bar span {
            color: white;
            text-align: center;
            line-height: 10px;  /* Menyesuaikan tinggi bar agar teks tetap berada di tengah */
            display: block;
            font-weight: bold;
        }

        /* Tambahkan scroll untuk tabel */
        .uk-overflow-auto {
            overflow-x: auto; /* Scroll horizontal jika diperlukan */
            max-height: 800px; /* Batasi tinggi untuk memunculkan scroll */
            background-color: white; 
        }

        .uk-table tbody td {
            font-size: 11.5px;
            border: 0.85px solid #ddd;
            padding: 6px;
            white-space: nowrap;
        }
        .uk-background{
            background-color: #e2e2e2 !important;
        }
       
        .merah{
            font-weight: bold;
            color: rgb(250, 249, 249) !important;
            background-color:#eb6464!important;
        }
        .buy {
            color:#05a705;
            font-weight:bolder;
        }
        .sell {
            color:#ea0c0c;
            font-weight:bolder;
        }
        .ijo {
            color: black !important;
            font-weight: bolder;
        }
        .error{
            color: #fafafa!important;
            background-color: #f39999!important;
        }
        .errorrestapi{
            background-color: #f6f2f1!important;
        }
       
        /* .sinyal-item {
            margin-bottom: 2px;  
            padding-bottom: 1px; 
            border-bottom: 1px solid #ccc;  
        } */
        #sinyal-container {
            display: flex;
            flex-wrap: wrap;
            width: 100%;
            gap: 10px;
            box-sizing: border-box;
        }

        .sinyal-item {
            flex: 1 1 220px;    /* fleksibel, responsif */
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
            min-height: 40px;
        }


        body{
            font-family: Arial, Helvetica, sans-serif;
            padding: 1px;
            /* background-image: linear-gradient(#cffad4, #fefefe, #f3f7f4); */
            color: #0f0f0f;
        }
        .icon-wrapper {
            display: inline-flex;          /* Menjadikan elemen inline fleksibel */
            justify-content: center;       /* Pusatkan gambar secara horizontal */
            align-items: center;           /* Pusatkan gambar secara vertikal */
            margin: 10px;
            transform: scale(1.6);              /* Tinggi ikon */
            background-color: #f97aa8;     /* Warna latar belakang */
            border-radius: 35%;            /* Membuat bentuk lingkaran */
            cursor: pointer;               /* Ubah kursor menjadi tangan saat diklik */
            transition: background-color 0.3s ease; /* Animasi untuk efek hover */
        }
        /* Warna link default (light mode) */
        a, .uk-link {
            color: inherit !important;
            text-decoration: none;
        }

        /* Warna link dalam dark mode */
        .dark-mode a,
        .dark-mode .uk-link {
            color: #4fc3f7 !important;  /* Warna biru muda, bisa diganti sesuai preferensi */
        }
        
        .dark-mode .uk-background {
            background-color: #797a7af5 !important;
        }

        body.dark-mode .uk-background-a {
            background-color: #6d6e6df5 !important;
        }

        /* Mode terang (default) */
        /* #sinyal-container {
            background-color: #eefbef !important;
            color: #000 !important;
        } */
        /* Mode gelap */
        body.uk-dark #sinyal-container {
            background-color: #605d5d !important;
            color: #f0f0f0 !important;
        }

        /* CSS dark mode */
        body {
            transition: background-color 0.3s, color 0.3s;
        }

        .dark-mode {
            background-color: #121212 !important;
            color: #5d0404 !important
        }

        .dark-mode .uk-table tbody td {
            background-color: #1e1e1e ;
            color: #f0f0f0 !important;
            border-color: #444 !important;
        }

        .dark-mode .uk-overflow-auto {
            background-color: #1a1a1a !important;
        }

        .dark-mode .uk-button {
            background-color: #333 !important;
            color: #fff !important;
            border-color: #555 !important;
        }

        .dark-mode .icon-wrapper {
            background-color: #333 !important;
        }

        .dark-mode .merah {
            background-color: #b00020 !important;
            color: #fff !important;
        }

        .dark-mode .buy {
            color:#20be20 !important
        }

        .dark-mode .sell {
            color: #ff6666 !important;
        }
        #darkModeToggle {
            width: 17px;
            height: 17px;
            background-color: #f0f0f0;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            position: fixed;
            top: 12px;
            right: 12px;
            z-index: 9999;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.15);
            transition: background-color 0.3s ease;
        }
        .dark-mode #darkModeToggle {
            background-color: #333;
        }
    </style>
    <!-- <base href="/V1/"> -->
</head>
<body>
<div class="uk-container uk-margin-small-top uk-background-a">
        <div class="uk-flex uk-flex-between uk-grid-small uk-margin " uk-grid style="flex: 1;">
            <!-- Bagian Kiri (Form) -->
            <div class="uk-width-auto">
                <div id="darkModeToggle" onclick="toggleDarkMode()" class="icon-wrapper" title="Ganti Mode Gelap/Terang">
                    <span uk-icon="icon: moon; ratio: 0.4"></span> 🌓
                </div>
                <h2 id="judul" class="uk-margin-remove" style="font-size: 30px; text-align:center;">
                    FAVORITE SCAN  V1.7  :: <label id="namachain"></label> 
                    <!-- <img src="https://coopsugar.org/storage/2022/03/new.gif" width="50px" /> &nbsp; -->
                </h2>
                <a href="index.html" target="_blank">
                    <img class="icon" id="Scanner" title="SCANNER PRICE" width="35px" src="https://cdn.iconscout.com/icon/premium/png-256-thumb/copy-cat-5381934-4568586.png" />
                </a>
                <!-- <img class="icon" id="SettingModal" title="CONFIG SCANNER" width="30px" src="https://cdn-icons-png.flaticon.com/512/1170/1170635.png" /> -->
                <!-- <img class="icon" id="UpdateWalletCEX" title="UPDATE WALLET CEX" width="30px" src="https://images.freeimages.com/fic/images/icons/2770/ios_7_icons/512/wallet.png" /> -->
                <a href="manajemen_aset.html" target="_blank">
                    <img class="icon" id="Modal" title="MANAJEMEN ASSET" width="30px" src="https://cdn-icons-png.flaticon.com/512/1194/1194711.png" />
                </a>
                <!-- <a href="multipair.html" target="_blank">
                    <img class="icon" id="MasterData" title="SETTING DATA" width="30px" src="https://cdn-icons-png.flaticon.com/128/3934/3934107.png" />
                </a> -->
                <a href="https://cors-anywhere.herokuapp.com/corsdemo" target="_blank">
                    <img class="icon" id="BukaKunci" title="BUKA AKSES" width="30px" src="https://cdn-icons-png.flaticon.com/512/9921/9921748.png" />
                </a>
                <img class="icon" id="reload" title="REFRESH PAGE" width="30px" src="https://cdn-icons-png.flaticon.com/512/2546/2546705.png" />
              
                <span id="chain-links-container"></span>        
                <h6 id="config" class="uk-margin-remove uk-text-left uk-text-danger">---</h6>        
            </div>
    
            <!-- Bagian Kanan (Konten Lainnya) -->
            <div class="uk-width-expand uk-margin-small-top">
                <form id="cryptoForm" style=" width: 96%;">
                           
                            <div class="uk-width-auto uk-flex uk-flex-middle  uk-text-small">
                                <!-- Tombol Download (ikon merah) -->
                                <a href="#" onclick="downloadTokenScannerJSON()" title="Download LIST TOKEN"  style=" color: red !important;">
                                    <span uk-icon="icon: bag; ratio: 0.7"></span>
                                </a>

                                <!-- Tombol Upload (ikon hijau) -->
                                <label for="uploadJSON" title="Upload LIST TOKEN" style=" color: green !important; cursor:pointer; margin-left:5px;">
                                    <span uk-icon="icon: cloud-upload; ratio: 0.9"></span>
                                </label>
                                &nbsp;&nbsp; 
                                <input type="file" id="uploadJSON" accept="application/json" style="display:none;" onchange="uploadTokenScannerJSON(event)">
                
                                <b><span class="uk-text-danger uk-text-medium">INFO: &nbsp;</span></b>
                                <b><span class="uk-text-primary uk-text-medium" id="infoAPP">???</span></b>&nbsp; &nbsp; &nbsp;
                            </div> 
                                  
                            <div class="uk-width-auto uk-flex uk-flex-middle uk-margin-small-top uk-text-small">
                                <div class="uk-width-auto uk-flex uk-flex-middle  uk-margin-remove-top uk-text-small">
                                    <div id="dex-options" class="uk-form-controls" style="display: flex;">
                                        <!-- Radio button DEX akan di-generate di sini -->
                                    </div>
                                
                                </div>
                            </div>
                            <!-- Kolom untuk DEX -->
                            <div class="uk-width-auto uk-flex uk-flex-middle uk-margin-small-top uk-text-small">
                                      <!-- Kolom untuk SETTING SCANNER -->
                                <div class="uk-width-auto uk-flex uk-flex-middle">
                                    <span class="uk-form-label uk-text-secondary uk-text-bolder">SCANNER : 
                                        <span class="uk-form-label uk-text-success">
                                            <input type="checkbox" checked class="posisi-check" value="Actionkiri"> KIRI 
                                            <input type="checkbox" checked class="posisi-check" value="ActionKanan"> KANAN
                                        </span>  
                                    </span>
                                    &nbsp;&nbsp;
                                    <span class="uk-form-label uk-text-warning uk-text-bolder">SORTING : 
                                        <span class="uk-form-label uk-text-secondary">
                                            <input type="radio" name="toggle" checked value="opt_A"> A 
                                            <input type="radio" name="toggle" value="opt_B"> Z
                                        </span>  
                                        <span class="uk-form-label uk-text-primary">
                                            <input type="checkbox" checked id="strictFilter"> WALLET CEX
                                        </span>  &nbsp;&nbsp;&nbsp;&nbsp;
                                        <span class="uk-form-label uk-text-success">
                                            <input type="checkbox" class="vol-check" id="checkVOL"> VOL CHECK
                                        </span>  
                                    </span> &nbsp;&nbsp;&nbsp;&nbsp;
                                </div>
                                <span class="uk-form-label uk-text-danger uk-text-danger uk-text-bolder">
                                   AUTOSCAN  <input type="checkbox" id="autorun">
                                </span> 
                                  &nbsp; &nbsp; &nbsp; &nbsp;  &nbsp; &nbsp; &nbsp; &nbsp; 
                                <button type="button" id="startSCAN" style="display: none;" class="uk-button uk-button-secondary uk-button-small">START</button>
                                <button type="button" id="stopSCAN" style="display: none;" class="uk-button uk-button-danger uk-button-small">STOP</button>                                

                            </div>
        
                        
                </form>
            </div>
        </div>

    <!-- Modal UIKIT -->
    <div id="modal-setting" class="uk-modal-full" uk-modal>
        <div class="uk-modal-dialog">
            <button class="uk-modal-close-full uk-close-large" type="button" uk-close></button>
            <div class="uk-modal-header">
                <h2 class="uk-modal-title">:: SETTING MODAL & SCANNER</h2>
               
            </div>
            <div class="uk-modal-body">
                <form> 
                    <!-- Grid UIkit untuk 2 kolom -->
                    <div class="uk-grid-small" uk-grid>
                        
                        <div class="uk-width-1-2">
                            
                            <!-- Kolom pertama -->
                            <div class="uk-card uk-card-default uk-card-body">
                                <div id="modal-container"></div>                                
                            </div>

                        </div>
                        <div class="uk-width-1-2">
                            <!-- Kolom kedua -->
                            <div class="uk-card uk-card-default uk-card-body">
                                <h3 style="text-align: center; margin: 12px 0px; color: #1317e1;">:: SETINGAN SCANNER</h3>
                                <label for="pnl">NICK NAME:</label>
                                <input type="text" id="user"  class="uk-input" required>

                                <div class="uk-flex uk-flex-middle uk-margin ">
                                    <!-- <div style="display: none;"> -->
                                       <div>
                                           <label for="jeda-time-group" class="uk-text-danger">KOIN/GRUP : </label>
                                           <label class="uk-form-label uk-text-success"><input class="uk-radio" type="radio" value="7" name="koin-group"> 7</label>                                          
                                           <label class="uk-form-label uk-text-success"><input class="uk-radio" type="radio" value="6"  name="koin-group"> 6</label> 
                                           <label class="uk-form-label uk-text-success"><input class="uk-radio" type="radio" value="5" checked name="koin-group"> 5</label>
                                           <label class="uk-form-label uk-text-success"><input class="uk-radio" type="radio" value="4"  name="koin-group"> 4</label>  
                                        </div>
                                    </div>
                                <div class="uk-flex uk-flex-middle uk-margin ">
                                       <div>
                                            <label for="SPEEDSCAN" class="uk-text-danger">WAKTU TUNGGU</label>
                                            <label class="uk-form-label uk-text-success"><input class="uk-radio" type="radio" value="2"  name="waktu-tunggu"> NORMAL </label>
                                            <label class="uk-form-label uk-text-success"><input class="uk-radio" type="radio" value="1.5" name="waktu-tunggu"> MEDIUM </label>
                                            <label class="uk-form-label uk-text-success"><input class="uk-radio" type="radio" value="1" name="waktu-tunggu"> FAST </label>
                                        </div>
                                   </div>
                                <div>
                                </div>
                                
                                <div class="uk-flex uk-flex-middle uk-margin ">
                                 <!-- <div style="display: none;"> -->
                                    <div>
                                        <label for="jeda-koin" class="uk-text-warning">FILTER PNL</label><br/>
                                        <input class="uk-input" type="number" id="inFilterPNL" value="0" name="filterpnl" >         
                                    </div>
                                    <div>
                                        <label for="jeda-time-group" class="uk-text-danger">JEDA / GROUP {1500}</label><br/>
                                        <input class="uk-input" id="jeda-time-group" type="number" value="1500" name="jeda-time-group" >
                                    </div>
                                    <div>
                                        <label for="jeda-koin" class="uk-text-primary">JEDA / KOIN {300}</label><br/>
                                        <input class="uk-input" type="number" id="jeda-koin" value="300" name="jeda-koin" > 
                                    </div>
                                </div>

                                    <div>
                                        <label for="walletMeta" class="uk-text-danger">WALLET ADDRESS</label><br />
                                        <input class="uk-input" type="text" id="walletMeta" name="walletMeta" >
                                    </div>
                                <div>                          
                                              
                                </div>
                                
                                <p class="uk-text-right">
                                    <button class="uk-button uk-button-default uk-modal-close" type="button">Tutup</button>
                                    <button type="button" id="save-config" class="uk-button uk-button-primary">SIMPAN</button>  
                                </p>   
                            </div>
                        </div>
                    </div>
             
                </form>
            </div>
        </div>
    </div>

    <div>
        <!-- Bagian untuk menampilkan sinyal DEX -->
        <div class="uk-text uk-text-small uk-margin-small-top" id="sinyal-container">
            <!-- Sinyal DEX akan dimuat di sini -->
        </div>
        <div class="uk-grid-small uk-flex uk-flex-middle  uk-margin-small-top" uk-grid>
            <!-- Judul dan Jumlah Token -->
            <div class="uk-width-expand">
                <h4 class="uk-heading-line uk-margin-remove" id="daftar">
                    <span style="font-size:medium; font-weight: bolder;">DAFTAR TOKEN PAIR ::  <span id="namachain2"></span> (<span id="tokenCountALL" class="token-count">0</span>)</span>
                    
                </h4>
            </div>
           
            <!-- Pencarian -->
            <div class="uk-width-auto uk-flex uk-flex-middle">
                <!-- <span class="uk-form-label uk-text-warning uk-text-bolder">POSISI : 
                    <span class="uk-form-label uk-text-success">
                        <input type="checkbox" checked class="posisi-check" value="Actionkiri"> KIRI 
                        <input type="checkbox" checked class="posisi-check" value="ActionKanan"> KANAN
                    </span>  
                </span>
                &nbsp;&nbsp;
                <span class="uk-form-label uk-text-danger uk-text-bolder">SORTING : 
                    <span class="uk-form-label uk-text-primary">
                        <input type="radio" name="toggle" checked value="opt_A"> A 
                        <input type="radio" name="toggle" value="opt_B"> Z
                        <input type="checkbox" checked id="strictFilter"> WALLET CEX
                        </span>  
                </span> -->
                &nbsp;&nbsp;&nbsp;
                <input type="text" id="searchInput" class="uk-input uk-form-small uk-form-primary uk-form-width-small" placeholder="Cari di tabel...">
            </div>
        </div>
    </div>

    <div id="progress-container" style="width: 100%; background-color: #f3f3f3; border-radius: 10px; margin-top: 10px;">
        <div id="progress-bar" style="height: 14px; width: 0%; background-color: #4caf50; border-radius: 5px;">
            <span id="progress-text" style="color: white; font-size: 12px; text-align: center; line-height: 10px; display: block; font-weight: bold;">0%</span>
        </div>
    </div>
    <div id="progress" style="font-size: 14px; font-weight: bold; margin-top: 5px;"></div>
    
    <div class="uk-overflow-auto uk-margin-small-top">
        <table class="uk-table uk-table-hover uk-table-small uk-table-striped">
            <thead class="table-header">
                <tr>
                    <!-- Kolom-kolom header akan ditambahkan secara dinamis -->
                </tr>
            </thead>
            <tbody id="dataTableBody">
                <!-- Baris-baris data akan ditambahkan secara dinamis -->
            </tbody>
        </table>
        <div id="InfoAPP" style="text-align:center; font-weight:bold; color:red;"></div>    
        <div id="InfoStatus" style="text-align:center; font-weight:bold; color:red;"></div>    
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- JS untuk dark mode -->
<script>
    
    </script>
    
<script>
    toastr.options = {
        "timeOut": "2500",            // Durasi munculnya toastr dalam milidetik
        "extendedTimeOut": "2000",    // Waktu tambahan saat toastr di-hover
        "closeButton": true,          // Tampilkan tombol close (opsional)
        "progressBar": true,          // Tampilkan progress bar (opsional)
        "positionClass": "toast-top-right" // Posisi toastr (ubah sesuai kebutuhan)
    };

    // Mendapatkan parameter dari URL
    const urlParams = new URLSearchParams(window.location.search);
    const chainName = urlParams.get('chain') || "bsc"; // Default ke 'bsc' jika tidak ada parameter 'chain' di URL

    // Memilih chain yang sesuai berdasarkan parameter URL
    const selectedChain = CONFIG_CHAINS[chainName] || CONFIG_CHAINS['bsc']; 

    // Mengatur konfigurasi global chain berdasarkan input dari URL
    const { Kode_Chain, Nama_Chain, URL_Chain, pairs } = selectedChain; 

    const storagePrefix = "MULTISCAN_V1_" + Nama_Chain.toUpperCase() + "_";
    let sortOrder = {};
    const stablecoins = ["USDT", "DAI", "USDC", "FDUSD"];
    const makfav=100;

    // Fungsi umum untuk mendapatkan data dari localStorage
    function getFromLocalStorage(key, defaultValue) {
        return JSON.parse(localStorage.getItem(storagePrefix + key)) || defaultValue;
       // console.log("Data from localStorage:", data); // Debug log
    }

    function getFromLocalStorageBARU(key, defaultValue = []) {
        try {
            const raw = localStorage.getItem(storagePrefix + key);
            const parsed = JSON.parse(raw);

            if (Array.isArray(parsed)) return parsed;
            console.warn("Data bukan array:", parsed);
            return defaultValue;

        } catch (e) {
            console.warn("Gagal parsing data localStorage:", e);
            return defaultValue;
        }
    }

    // Fungsi umum untuk menyimpan data ke localStorage
    function saveToLocalStorage(key, value) {
        try {
            localStorage.setItem(storagePrefix + key, JSON.stringify(value));
           // console.log("Data saved successfully:", key);
        } catch (error) {
            // Tambahkan log untuk memverifikasi jenis error
            console.error("Error saat menyimpan data:", error);

            if (error.name === "QuotaExceededError") {
                // Tambahkan pengecekan ruang yang tersedia sebelum menyimpan
                let usedSpace = new Blob(Object.values(localStorage)).size;
                let totalSpace = 5 * 1024 * 1024; // Biasanya 5MB
                console.error(`Used space: ${usedSpace} bytes / Total allowed: ${totalSpace} bytes`);

                toastr.error("MEMORY BROWSER PENUH!!! Sisa ruang tidak mencukupi.");
            } else {
                toastr.error("Terjadi kesalahan tak terduga saat menyimpan data.");
            }
        }
    }

    // Fungsi untuk menghapus item dari localStorage
    function removeFromLocalStorage(key) {
        localStorage.removeItem(storagePrefix + key);
       // console.log("Remove from localStorage:", key); // Debug log
    }

    const TOKEN_KEY = "TOKEN_SCANNER";
    const SETTING_KEY = "DATA_SETTING";

    function downloadTokenScannerJSON() {
        // Ambil data dari localStorage
        const tokenData = getFromLocalStorage("TOKEN_FAV_SCANNER", []);
        const settingData = getFromLocalStorage("DATA_SETTING", {});

        // Gabungkan data ke dalam satu objek
        const combined = {
            "TOKEN_FAV_SCANNER": tokenData,
            "DATA_SETTING": settingData
        };

        // Konversi ke file JSON
        const blob = new Blob([JSON.stringify(combined, null, 2)], {
            type: "application/json"
        });

        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");

        a.href = url;
        a.download = "PROFIL_FAV_APP.json";
        document.body.appendChild(a);
        a.click();

        // Bersihkan elemen dan URL
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        setLastAction("DOWNLOAD PROFIL");
    }

    function uploadTokenScannerJSON(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const json = JSON.parse(e.target.result);

                const userConfirmed = window.confirm("APAKAH ANDA INGIN UPLOAD FILE?");
                if (!userConfirmed) {
                    toastr.info("Upload dibatalkan.");
                    return;
                }

                // Cek dan simpan data token
                if (json["TOKEN_FAV_SCANNER"]) {
                    saveToLocalStorage("TOKEN_FAV_SCANNER", json["TOKEN_FAV_SCANNER"]);
                } else {
                    console.warn("TOKEN_FAV_SCANNER tidak ditemukan di file.");
                }

                // Cek dan simpan data setting
                if (json["DATA_SETTING"]) {
                    saveToLocalStorage("DATA_SETTING", json["DATA_SETTING"]);
                } else {
                    console.warn("DATA_SETTING tidak ditemukan di file.");
                }

                setLastAction("UPLOAD PROFIL");
                toastr.success("Data berhasil diupload!");
                location.reload();

            } catch (error) {
                console.error("Error parsing JSON:", error);
                toastr.error("Format file JSON tidak valid!");
            }
        };
        reader.readAsText(file);
    }

    
    // Fungsi untuk mendapatkan data chain berdasarkan nama chain
    function getChainData(chainName) {
        const chainData = CONFIG_CHAINS[chainName]; // base
        
        if (!chainData) {
            console.log(`Chain dengan nama ${chainName} tidak ditemukan.`);
            return null;
        }
        return {
            Kode_Chain: chainData.Kode_Chain,
            Nama_Chain: chainData.Nama_Chain,
            DEXS: chainData.DEXS,
            PAIRDEXS: chainData.PAIRDEXS,
            URL_Chain: chainData.URL_Chain, 
            DATAJSON: chainData.DATAJSON, 
            BaseFEEDEX: chainData.BaseFEEDEX, 
            CEXCHAIN: chainData.WALLET_CEX,
            ICON_CHAIN: chainData.ICON,
            COLOR_CHAIN: chainData.WARNA,
        };
    }

    
    function toggleDarkMode() {
        const isDark = document.body.classList.toggle('dark-mode');    
        document.body.classList.remove('uk-light', 'uk-dark');
        document.body.classList.add(isDark ? 'uk-dark' : 'uk-light');

        saveToLocalStorage("darkMode", isDark);
        updateDarkIcon(isDark);

        toastr.info("UBAH MODE BERHASIL!!");
        // Tunggu sebentar sebelum reload
        setTimeout(() => {
            location.reload();
        }, 500);
    }

    function updateDarkIcon(isDark) {
        const icon = document.querySelector('#darkModeToggle span');
        if (icon) {
            icon.setAttribute("uk-icon", isDark ? "icon: sun; ratio: 1.4" : "icon: moon; ratio: 1.4");
            UIkit.icon(icon).$emit('update'); // refresh ikon
        }
    }
        
   // Fungsi untuk memilih server secara acak dari array
   function getRandomServerFromCORSList() {
        const serverCORSList = getFromLocalStorage("SERVERCORS", []);  // Ambil data dari localStorage
    
        if (!serverCORSList || serverCORSList.length === 0) {
            toastr.warning("DATA SETTING TIDAK ADA, SILAKAN SYCN ULANG!!");
            return null; // Tidak ada server dalam daftar
        }
    
        // Pilih server secara acak
        const randomIndex = Math.floor(Math.random() * serverCORSList.length);
        return serverCORSList[randomIndex];
    }
    
    // Menggunakan fungsi untuk mendapatkan server CORS secara acak
    var selectedServer = getRandomServerFromCORSList();
    const DTChain = getChainData(chainName);  
    var SavedSettingData = getFromLocalStorage('DATA_SETTING', {});
    var DataTokens = getFromLocalStorage('TOKEN_FAV_SCANNER',[]);
    var MasterTokens = getFromLocalStorage('TOKEN',[]);
    var serverCORSList = getFromLocalStorage("SERVERCORS", []); 
    var WalletCEX = getFromLocalStorage("WALLET_CEX", []); 
    // Proses jika semua data valid
    var savedPairs = getFromLocalStorage("selectedPair", []);
    var savedCexs = getFromLocalStorage("selectedCEX", []);

    const dexList = [
            { id: 'D1INCH', Modal: SavedSettingData.Modal1INCH,  dex: '1inch' },
            { id: 'DODOS', Modal: SavedSettingData.ModalODOS, dex: 'odos' },
            { id: 'D0X', Modal: SavedSettingData.Modal0X,  dex: '0x' },
            { id: 'DKYBERSWAP', Modal: SavedSettingData.ModalKYBERSWAP, dex: 'kyberswap' },
            { id: 'DJUPITER', Modal: SavedSettingData.ModalJUPITER,  dex: 'jupiter' },
            { id: 'DOKX', Modal: SavedSettingData.ModalOKX,  dex: 'okx' },
            { id: 'DMAGPIE', Modal: SavedSettingData.ModalMAGPIE,  dex: 'magpie' },
            { id: 'DPARASWAP', Modal: SavedSettingData.ModalPARASWAP,  dex: 'paraswap' },
            { id: 'DOPENOCEAN', Modal: SavedSettingData.ModalPARASWAP,  dex: 'openocean' },
            { id: 'DKANA', Modal: SavedSettingData.ModalKANA,  dex: 'kana' },
            { id: 'DLIFI', Modal: SavedSettingData.ModalLIFI,  dex: 'lifi' }
        ];

    let filteredTokens = [];

    function filterTokens(strictMode) {
        const allTokens = getFromLocalStorage("TOKEN_FAV_SCANNER", []);
        const selectedCEX = getFromLocalStorage("CEX_PILIH", []);
        const selectedDEXPAIR = getFromLocalStorage("DEXPAIR_PILIH", []);
        const selectedDEX = getFromLocalStorage("DEX_PILIH", []);

       // console.warn("TOKEN DataTokens", allTokens);

        if (!Array.isArray(allTokens) || allTokens.length === 0) {
            console.warn("No tokens available for filtering.");
            filteredTokens = [];
            updateTokenCount();
            return;
        }
        // console.log("Memanggil filterTokens(), strictMode:", strictMode);
        // console.log("selectedCEX", selectedCEX);
        // console.log("selectedDEXPAIR", selectedDEXPAIR);
        // console.log("selectedDEX", selectedDEX);
        // console.log("allTokens", allTokens); // Pastikan ini tampil

        const isNonSelected = selectedDEXPAIR.includes("NON");
        const dexPairs = Object.keys(DTChain.PAIRDEXS).filter(pair => pair !== "NON");

        filteredTokens = allTokens.filter(token => {
            if (!token?.cex || !token?.symbol_in || !token?.symbol_out) return false;

            const validCEX = selectedCEX.includes(token.cex);
            const validDexPair = selectedDEXPAIR.some(pair => token.symbol_in === pair || token.symbol_out === pair) ||
                (isNonSelected && !dexPairs.some(pair => token.symbol_in === pair || token.symbol_out === pair));

            if (!token.status) return false;
            if (strictMode && (!token.withdrawToken || !token.depositPair || !token.withdrawPair || !token.depositToken)) return false;
            
            return true;
        }).sort((a, b) => a.symbol_in.localeCompare(b.symbol_in));  // <-- ini tambahan untuk mengurutkan

        if (filteredTokens.length === 0 && selectedCEX.length > 0 && selectedDEX.length > 0) {
            toastr.error("TIDAK ADA TOKEN-PAIR YANG SESUAI CEX/DEX/PAIRDEX !!");
            console.warn("No tokens matched the filtering criteria.");
        }

        updateTokenCount();
    }

    function updateTokenCount() {
        $("#tokenCount").text(`(${filteredTokens.length})`);
        console.warn("Tokens data", filteredTokens);
    }

    $("#strictFilter").on("change", function() {
        filterTokens($(this).is(":checked"));
    });

    // Inisialisasi dengan status awal checkbox
    filterTokens($("#strictFilter").is(":checked"));

    $("input[name='toggle']").change(function () {
        var selectedOption = $("input[name='toggle']:checked").val();
        if (selectedOption === "opt_B") {
            // Jika "Z" dipilih, balik urutan
            filteredTokens.reverse();
            toastr.info("SORTING TOKEN PAIR BERUBAH KE -Z");
        }else{
            toastr.info("SORTING TOKEN PAIR BERUBAH KE -A");
        }
        // Lakukan update tampilan sesuai perubahan sorting
        loadStoredData(filteredTokens);
    });

    $(document).on('click', `[id^="DelAuto-"]`, function () {
        console.log("HAPUS KOIN AUTO");

        const index = $(this).data('index');
        const item = filteredTokens[index];

        if (!item) {
            console.warn("Data tidak ditemukan di filteredTokens", index);
            return;
        }

        // Ambil data token yang sudah disimpan
        let tokens = getFromLocalStorage('TOKEN_FAV_SCANNER', []);
        if (!Array.isArray(tokens)) tokens = [];

        // Hapus berdasarkan item.no
        tokens = tokens.filter(t => t.no !== item.no);

        // Simpan ulang
        saveToLocalStorage('TOKEN_FAV_SCANNER', tokens);

        // Tampilkan notifikasi
        toastr.success("Token berhasil dihapus", `Dihapus: ${item.symbol_in}`, {
            timeOut: 3000,
            closeButton: true
        });

        // Refresh halaman (atau bisa panggil fungsi update UI jika tidak ingin full reload)
        setTimeout(() => location.reload(), 500);
    });


    //console.log("DATA TOKEN FILTER",filteredTokens);
    // Mapping konfigurasi untuk setiap exchange
    const exchangeConfig = {
        GATE: {
            url: coins => `https://api.gateio.ws/api/v4/spot/order_book?limit=5&currency_pair=${coins.symbol}_USDT`,
            processData: data => processOrderBook(data)
        },
        BINANCE: {
            url: coins => `https://api.binance.me/api/v3/depth?limit=4&symbol=${coins.symbol}USDT`,
            processData: data => processOrderBook(data)
        },
        MEXC: {
            url: coins => `https://api.mexc.com/api/v3/depth?symbol=${coins.symbol}USDT&limit=5`,
            processData: data => processOrderBook(data)
        },
        KUCOIN: {
          //  url: coins => `https://proxykiri.awokawok.workers.dev/?https://api.kucoin.com/api/v1/market/orderbook/level2_20?symbol=${coins.symbol}-USDT`,
            url: coins => `https://api.kucoin.com/api/v1/market/orderbook/level2_20?symbol=${coins.symbol}-USDT`,
            processData: data => {
                if (!data?.data?.asks || !data?.data?.bids) {
                    console.error('Invalid KUCOIN response structure:', data);
                    return { priceBuy: [], priceSell: [] };
                }
                const priceBuy = data.data.bids.slice(0, 3).map(([price, volume]) => ({
                    price: parseFloat(price),
                    volume: parseFloat(volume) * parseFloat(price)
                }));
                const priceSell = data.data.asks.slice(0, 3).map(([price, volume]) => ({
                    price: parseFloat(price),
                    volume: parseFloat(volume) * parseFloat(price)
                }));
                return { priceBuy, priceSell };
            }
        },
        BITGET: {
            url: coins => `https://api.bitget.com/api/v2/spot/market/orderbook?symbol=${coins.symbol}USDT&limit=5`,
            processData: data => {
                if (!data?.data?.asks || !data?.data?.bids) {
                    console.error('Invalid BITGET response structure:', data);
                    return { priceBuy: [], priceSell: [] };
                }
                const priceBuy = data.data.bids.slice(0, 4).map(([price, volume]) => ({
                    price: parseFloat(price),
                    volume: parseFloat(volume) * parseFloat(price)
                }));
                const priceSell = data.data.asks.slice(0, 4).map(([price, volume]) => ({
                    price: parseFloat(price),
                    volume: parseFloat(volume) * parseFloat(price)
                }));
                return { priceBuy, priceSell };
            }
        },
        BYBIT: {
            url: coins => `https://api.bybit.com/v5/market/orderbook?category=spot&limit=4&symbol=${coins.symbol}USDT`,
            processData: data => {
                if (!data?.result?.a || !data?.result?.b) {
                    console.error('Invalid BYBIT response structure:', data);
                    return { priceBuy: [], priceSell: [] };
                }
                const priceBuy = data.result.b.slice(0, 4).map(([price, volume]) => ({
                    price: parseFloat(price),
                    volume: parseFloat(volume) * parseFloat(price)
                }));
                const priceSell = data.result.a.slice(0, 4).map(([price, volume]) => ({
                    price: parseFloat(price),
                    volume: parseFloat(volume) * parseFloat(price)
                }));
                return { priceBuy, priceSell };
            }
        },
        OKX: {
            url: coins => `https://www.okx.com/api/v5/market/books?instId=${coins.symbol}-USDT&sz=5`,
            processData: data => {
                if (!data?.data?.[0]?.asks || !data?.data?.[0]?.bids) {
                    console.error('Invalid OKX response structure:', data);
                    return { priceBuy: [], priceSell: [] };
                }
                const priceBuy = data.data[0].bids.slice(0, 4).map(([price, volume]) => ({
                    price: parseFloat(price),
                    volume: parseFloat(volume) * parseFloat(price)
                }));
                const priceSell = data.data[0].asks.slice(0, 4).map(([price, volume]) => ({
                    price: parseFloat(price),
                    volume: parseFloat(volume) * parseFloat(price)
                }));
                return { priceBuy, priceSell };
            }
        },
        INDODAX: {
            url: coins => `https://indodax.com/api/depth/${(coins.symbol).toLowerCase()}idr`,

            processData: data => {
                // Cek kalau data buy/sell tidak ada
                if (!data?.buy || !data?.sell) {
                    console.error('Invalid INDODAX response structure:', data);
                    return { priceBuy: [], priceSell: [] };
                }

                // Proses data BUY: langsung ambil 3 data teratas dari API (tidak di-sort)
                const priceBuy = data.buy
                    .slice(0, 3)
                    .map(([price, volume]) => {
                        const priceFloat = parseFloat(price);
                        const volumeFloat = parseFloat(volume);
                        return {
                            price: convertIDRtoUSDT(priceFloat),
                            volume: convertIDRtoUSDT(priceFloat * volumeFloat)
                        };
                    });

                // Proses data SELL: sort harga dari besar ke kecil, baru ambil 3 data teratas
                const priceSell = data.sell
                    .slice(0, 3)
                    .map(([price, volume]) => {
                        const priceFloat = parseFloat(price);
                        const volumeFloat = parseFloat(volume);
                        return {
                            price: convertIDRtoUSDT(priceFloat),
                            volume: convertIDRtoUSDT(priceFloat * volumeFloat)
                        };
                    });

                // Return hasil BUY dan SELL
                return { priceSell ,priceBuy};
            }
        },

        BITMART: {
            url: coins => selectedServer+`https://api-cloud.bitmart.com/spot/quotation/v3/books?symbol=${coins.symbol}_USDT&limit=3`,
            processData: data => {
                if (!data?.data?.asks || !data?.data?.bids) {
                    console.error('Invalid BITMART response structure:', data);
                    return { priceBuy: [], priceSell: [] };
                }
                const priceBuy = data.data.bids.slice(0, 3).map(([price, volume]) => ({
                    price: parseFloat(price),
                    volume: parseFloat(volume) * parseFloat(price)
                }));
                const priceSell = data.data.asks.slice(0, 3).map(([price, volume]) => ({
                    price: parseFloat(price),
                    volume: parseFloat(volume) * parseFloat(price)
                }));
                return { priceBuy, priceSell };
            }
        }

        ,COINEX: {
            url: coins => `https://api.coinex.com/v2/spot/depth?limit=5&interval=0.00000000001&market${coins.symbol}USDT`,
            processData: data => {
                if (!data?.data?.[0]?.asks || !data?.data?.[0]?.bids) {
                    console.error('Invalid COINEX response structure:', data);
                    return { priceBuy: [], priceSell: [] };
                }
                const priceBuy = data.data[0].bids.slice(0, 4).map(([price, volume]) => ({
                    price: parseFloat(price),
                    volume: parseFloat(volume) * parseFloat(price)
                }));
                const priceSell = data.data[0].asks.slice(0, 4).map(([price, volume]) => ({
                    price: parseFloat(price),
                    volume: parseFloat(volume) * parseFloat(price)
                }));
                return { priceBuy, priceSell };
            }
        }
    };   
    
    function convertIDRtoUSDT(idrAmount) {
        const rateUSDT = getFromLocalStorage("PriceRateUSDT", 0);
        if (!rateUSDT || rateUSDT === 0) return 0;
        return parseFloat((idrAmount / rateUSDT).toFixed(8));
    }

    function feeGasGwei() {
        const isSolana = (DTChain?.Nama_Chain || "").toLowerCase() === "solana";
        
        let lastPrice = null;  // Mendeklarasikan lastPrice agar bisa diakses secara global

        // Panggil Binance untuk semua chain
        $.ajax({
            url: 'https://data-api.binance.vision/api/v3/ticker/24hr?symbol=' + DTChain.BaseFEEDEX,
            method: 'GET'
        }).done(function (PriceResponse) {
            lastPrice = PriceResponse.lastPrice;  // Simpan nilai lastPrice
            saveToLocalStorage('PRICEGAS', lastPrice);
            console.log('BASE FEE '+DTChain.BaseFEEDEX+' FOR DEX:', lastPrice);

            // Jika bukan Solana, baru panggil Infura untuk gas fee
            if (!isSolana) {
                $.ajax({
                    url: 'https://gas.api.infura.io/v3/9d0429abadc34232af7d5c0e6ab98631/networks/' + DTChain.Kode_Chain + '/suggestedGasFees',
                    method: 'GET'
                }).done(function (gasResponse) {
                    const mediumGasFee = gasResponse.low.suggestedMaxFeePerGas;
                    saveToLocalStorage('gasGWEI', mediumGasFee);
                    console.log('FEE GAS GWEI:', mediumGasFee);
                    console.log('BASE FEE ' + DTChain.BaseFEEDEX + ' FOR DEX:', lastPrice);

                }).fail(function (error) {
                    console.error('Failed to fetch gas fee from Infura:', error);
                });
            } else {
                console.log('Chain Solana: Tidak perlu gas fee dari Infura.');
            }

        }).fail(function (error) {
            console.error('Failed to fetch price from Binance:', error);
        });
    }

    // Fungsi untuk menonaktifkan semua input di dalam form
    function form_off() {
        $('input, select, textarea, button').prop('disabled', true); 
    }

    // Fungsi untuk mengaktifkan semua input di dalam form
    function form_on() {
        $('input, select, button').prop('disabled', false);
    }

    UIkit.util.on('#modal-setting', 'show', function () {
        form_on();
    });

    function cekDataAwal() {
      //  console.log(DataTokens);
        var info = true; // Variabel status info
        let errorMessages = []; // Array untuk menyimpan pesan error

        // Validasi data dan push error ke array
        if (!MasterTokens.length) {
            errorMessages.push('TIDAK ADA DATA PADA SETTINGAN!!, SILAKAN KE MENU SETTINGAN.');
            $("#MasterData").addClass("icon-wrapper");
            $('#UpdateWalletCEX,#LoadDataBtn,#SettingModal').css('pointer-events', 'none').css('opacity', '0.4');
            info = false;
        } else if (!DataTokens.length) {
            form_off();
           // $("#LoadDataBtn").addClass("icon-wrapper");
            errorMessages.push('<b>SILAKAN PILIH TOKEN-PAIR TERLEBIH DAHULU !!</b><br/>');
            info = false;

        } else if (!SavedSettingData || SavedSettingData.walletMeta === '-') {
            errorMessages.push('CEK, SETTINGAN APLIKASI {MODAL,WALLET ADDRESS}!');
            $("#SettingModal").addClass("icon-wrapper");
            form_off();
            info = false;
        } else if (!WalletCEX.length) {
            errorMessages.push('TIDAK ADA DATA WALLET CEX, SILAKAN UPDATE WALLET PADA MENU SETTINGAN!');
            $("#MasterData").addClass("icon-wrapper");
            $('#UpdateWalletCEX').css('pointer-events', 'none').css('opacity', '0.4');
            info = false;
        } else {
            loadStoredData(filteredTokens);
           // generateInputCheckbox(savedCexs, "cex-options", "", "EXCH: ", "uk-form-label uk-text-success");
            generateInputCheckbox(DTChain.DEXS, "dex-options", "D", "DEFI: ", "uk-form-label uk-text-danger");
           // generateInputCheckbox(savedPairs, "dexpair-options", "", "", "uk-form-label uk-text-primary");
            generateInputModal(DTChain.DEXS);            
            loadCheckboxSelections();

            let waktuTunggu=SavedSettingData.speedScan;
            let speed=0;
            if (waktuTunggu == "2") {
                speed = "NORMAL";
            } else if (waktuTunggu == "1.5") {
                speed = "MEDIUM";
            } else if (waktuTunggu == "1") {
                speed = "FAST";
            }else{
                speed = "ANOMALI";
            }
            $("#config").text(`FilterPNL: ${SavedSettingData.filterPNL} | Grup: ${SavedSettingData.scanPerKoin} ~ ${speed} [${SavedSettingData.jedaTimeGroup}-${SavedSettingData.jedaKoin}] | Gwei: ${parseFloat(getFromLocalStorage('gasGWEI', 0)).toFixed(2)}`)
            // hitung total token
            const jml = DataTokens.filter(item => 
                item.status === true 
            ).length;

            $('#tokenCountALL').text(`TOTAL SEMUA: ${jml} / ${makfav} PAIR-TOKEN`);  
        }

        // Update link dengan parameter baru
        var link = $('a[href="multipair.html"]'); // Pilih elemen link
        var href = link.attr('href'); // Ambil URL href
        link.attr('href', href + "?chain=" + encodeURIComponent(chainName)); // Update href dengan parameter baru

        // Tampilkan semua pesan error ke #infoAPP
        if (!info) {
            $("#infoAPP").show().html(errorMessages.join("<br/>")); // Gabungkan semua pesan error
        }

        // Proses aksi terakhir jika kondisi terpenuhi
        var dataACTION = getFromLocalStorage('HISTORY');
        if (info && dataACTION && dataACTION.time) {
            $("#infoAPP").show().text(`${dataACTION.action} at ${dataACTION.time}`);
        }
    }

    $(document).ready(function() {  
    // dark mode change    
    const isDark = getFromLocalStorage("darkMode", false);
    if (isDark) {
        $('body').addClass('dark-mode uk-dark').removeClass('uk-light');
    } else {
        $('body').removeClass('dark-mode uk-dark');
    }
    updateDarkIcon(isDark);

    const infuraApiKey = '9d0429abadc34232af7d5c0e6ab98631';
    const urlParams = new URLSearchParams(window.location.search);
    const chain = urlParams.get('chain') || 'eth'; // Default ke 'eth' jika chain tidak ditemukan di URL

    // Definisikan RPC URL untuk masing-masing chain
    const chains = {
        eth: `https://mainnet.infura.io/v3/${infuraApiKey}`,
        bsc: 'https://bsc-dataseed.binance.org/',
        polygon: 'https://polygon-rpc.com',
        base: 'https://mainnet.base.org',
        arbitrum: `https://arbitrum-mainnet.infura.io/v3/${infuraApiKey}`,
        avax: `https://avalanche-mainnet.infura.io/v3/${infuraApiKey}`,
        optimism: `https://optimism-mainnet.infura.io/v3/${infuraApiKey}`,
        solana: solanaWeb3.clusterApiUrl('mainnet-beta')
    };

    // Tentukan URL RPC untuk chain yang dipilih
    let web3;
    if (chain === 'solana') {
        // Untuk Solana menggunakan Solana Web3.js (berbeda dari Ethereum, BSC, dll)
        web3 = new solanaWeb3.Connection(chains.solana);
    } else {
        // Untuk chain lainnya (Ethereum, BSC, Polygon, dll)
        web3 = new Web3(chains[chain]);
    }
        console.log(Web3.version);

        if (typeof CONFIG_CEX !== 'undefined' && typeof CONFIG_CHAINS !== 'undefined') {
            const currentPage = window.location.pathname.split('/').pop(); // Mengambil bagian terakhir dari path URL
            const selectedChain = CONFIG_CHAINS[Nama_Chain.toLowerCase()];
                // Pastikan data chain ditemukan
                if (selectedChain) {                    
                    // console.log(`Data untuk chain ${chainName}:`, DTChain);                
                    // console.log(`CEXS `, CONFIG_CEX); 
                    // console.log(`DEXS `, DTChain.DEXS); 
                    // generate CEX,DEX dan PAIR
                    function hexToRgba(hex, alpha) {
                        var r = parseInt(hex.slice(1, 3), 16);
                        var g = parseInt(hex.slice(3, 5), 16);
                        var b = parseInt(hex.slice(5, 7), 16);
                        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
                    }

                    var warnaAsli = selectedChain.WARNA; // Contoh: "#FF0000"
                    var warnaFaded = hexToRgba(warnaAsli, 0.1); // Alpha 0.3

                    $('#sinyal-container').css('background-color', warnaFaded);

                    // Update tampilan dengan nama chain dan warna
                    $('title').text(Nama_Chain.toUpperCase());
                    $('#namachain').text(Nama_Chain.toUpperCase());
                    $('#namachain2').text("CHAIN " + Nama_Chain.toUpperCase());
                    $('h2#judul').css('color', selectedChain.WARNA);
                    // $('#favicon').attr('href', DTChain.ICON_CHAIN); 
                    $('#progress-bar').css('background-color', selectedChain.WARNA);

                    $('#sinyal-container').css('color',"black");

                    $('h4#daftar').css({'text-align': 'center','color': selectedChain.WARNA,'padding-left':'4px'});
                   
                    cekDataAwal();
                        
                    // Untuk setiap chain yang ada di CONFIG_CHAINS dibuatkan ICON LINK CHAIN
                    Object.keys(CONFIG_CHAINS).forEach(chainKey => {
                        const chain = CONFIG_CHAINS[chainKey];
                        const isActive = chain.Nama_Chain === Nama_Chain;
                        const linkHTML = `<span class="chain-link" style="${!isActive ? 'opacity: 0.3;' : ''}">
                                <a href="${currentPage}?chain=${chain.Nama_Chain}" ><img src="${chain.ICON}" alt="${chain.Nama_Chain} icon" width="${isActive ? '30' : '30'}"></a></span>`;
                        $('#chain-links-container').append(linkHTML);
                    });
                } else {
                    alert(`Chain dengan nama ${Nama_Chain} tidak ditemukan.`);
                }
            } else {
                console.warn("CONFIG tidak tersedia.");
            }

            $('#searchInput').on('input', function() {
                const searchValue = $(this).val().toLowerCase();
                $('#dataTableBody tr').filter(function() {
                    $(this).toggle($(this).text().toLowerCase().indexOf(searchValue) > -1);
                });
            });

            $('.posisi-check').on('change', function () {
                const kiri = $('input[value="Actionkiri"]');
                const kanan = $('input[value="ActionKanan"]');
                
                // Cek jumlah yang dicentang
                const checkedCount = $('.posisi-check:checked').length;

                if (checkedCount === 0) {
                    // Kembalikan checkbox ini ke posisi sebelumnya (ON)
                    $(this).prop('checked', true);
                    toastr.error("Minimal salah satu POSISI harus aktif!");
                    return;
                }else{
                    $("#startSCAN").show();
                }

                const label = $(this).val() === 'Actionkiri' ? 'KIRI' : 'KANAN';
                const status = $(this).is(':checked') ? 'AKTIF' : 'NONAKTIF';
                toastr.info(`POSISI ${label} ${status}`);
            });

            $('.vol-check').on('change', function () {
                const checkedVOL = $('.vol-check:checked').length;

                if (checkedVOL == true) {
                    toastr.success("Checking Volume CEX Aktif!");
                    return;
                }else{
                    toastr.error("Checking Volume CEX NON Aktif!");

                }

            });

            $('#LoadDataBtn').on('click', function () {
                const storedData = getFromLocalStorage("TOKEN", []);
                const WalletCEXData = getFromLocalStorage("WALLET_CEX", []);

                // Gabungkan data terlebih dahulu (belum di-checksum)
                let combinedData = storedData.map(token => {
                    const walletToken = WalletCEXData.find(item =>
                        item.cex === token.cex && item.tokenName === token.symbol_in
                    );

                    const walletPair = WalletCEXData.find(item =>
                        item.cex === token.cex && item.tokenName === token.symbol_out
                    );

                    return {
                        ...token,
                        feeWDToken: walletToken ? walletToken.feeWDs : "",
                        feeWDPair: walletPair ? walletPair.feeWDs : "",
                        depositPair: walletPair ? walletPair.depositEnable : false,
                        withdrawToken: walletToken ? walletToken.withdrawEnable : false,
                        depositToken: walletToken ? walletToken.depositEnable : false,
                        withdrawPair: walletPair ? walletPair.withdrawEnable : false,
                    };
                });

            
                combinedData = combinedData.map(item => {
                    let sc_in_checksum = item.sc_in || "";
                    let sc_out_checksum = item.sc_out || "";

                    // Jika bukan chain Solana → lakukan checksum
                    if ((chain || "").toLowerCase() !== "solana") {
                        if (item.sc_in && web3.utils.isAddress(item.sc_in)) {
                            sc_in_checksum = web3.utils.toChecksumAddress(item.sc_in);
                        }
                        if (item.sc_out && web3.utils.isAddress(item.sc_out)) {
                            sc_out_checksum = web3.utils.toChecksumAddress(item.sc_out);
                        }
                    }

                    // Debug hasil ke konsol
                // console.info(`[${item.chain}] [SC_IN] ${item.symbol_in}: ${item.sc_in} → ${sc_in_checksum}`);
                // console.info(`[${item.chain}] [SC_OUT] ${item.symbol_out}: ${item.sc_out} → ${sc_out_checksum}`);

                    return {
                        ...item,
                        sc_in: sc_in_checksum,
                        sc_out: sc_out_checksum
                    };
                });

                // Konfirmasi penyimpanan
                if (confirm('LOAD DATA AKAN MERUBAH DATA SEBELUMNYA, LANJUTKAN??')) {
                    saveToLocalStorage("TOKEN_FAV_SCANNER", combinedData);

                    const savedData = getFromLocalStorage("TOKEN_FAV_SCANNER", []);
                    if (savedData.length === combinedData.length) {
                        toastr.info("LOADING DATA TOKEN PAIR...", {
                            timeOut: 3000,
                            progressBar: true,
                            closeButton: true,
                        });
                        setTimeout(() => location.reload(), 2000);
                    } else {
                        toastr.error("LOAD DATA GAGAL!", {
                            timeOut: 4000,
                            progressBar: true,
                            closeButton: true,
                        });
                    }
                } else {
                    toastr.info("PROSES LOAD DATA DIBATALKAN OLEH PENGGUNA.", {
                        timeOut: 3000,
                        progressBar: true,
                        closeButton: true,
                    });
                }
            });

            $("#stopSCAN,#reload").click(function () {
                location.reload();
            });


            $("#stopSCAN,#reload").click(function () {
                location.reload();
            });
            
    });

    function formatPrice(price) {
        if (price >= 1) {
            return price.toFixed(3) + '$'; // Jika >= 1, tampilkan 2 angka desimal
        }

        let strPrice = price.toFixed(20).replace(/0+$/, ''); // Paksa format desimal, hapus nol di akhir
        let match = strPrice.match(/0\.(0*)(\d+)/); // Ambil nol setelah koma dan angka signifikan

        if (match) {
            let zeroCount = match[1].length; // Hitung jumlah nol setelah koma
            let significant = match[2].substring(0, 4); // Ambil 5 digit signifikan pertama

            // Jika angka signifikan kurang dari 5 digit, tambahkan nol di akhir
            significant = significant.padEnd(4, '0');

            if (zeroCount >= 2) {
                return `0.{${zeroCount}}${significant}$`; // Format dengan {N} jika nol >= 2
            } else {
                return `0.${match[1]}${significant}$`; // Format biasa jika nol < 2
            }
        }

        return price.toFixed(6) + '$'; // Fallback jika format tidak dikenali
    }

    //scan dengan batas maksimum eksekusi pergrup (speedscan)
    $("#startSCAN").click(function () {
        
        cekDataAwal();
        sendStatusTELE(SavedSettingData.nickname, 'AUTO ON');
        CekIdentitas();
        $('#sinyal-container span[id^="sinyal"]').empty();
        form_off();

        $("#stopSCAN").show().prop('disabled', false);

        $('#LoadDataBtn, #SettingModal, #MasterData,#UpdateWalletCEX, #chain-links-container').css('pointer-events', 'none').css('opacity', '0.4');

        // Pastikan checkbox tetap aktif dan bisa diubah statusnya
        $('.statusCheckbox').css({ 'pointer-events': 'auto', 'opacity': '1' }).prop('disabled', false);

        let ConfigScan = getFromLocalStorage('DATA_SETTING', {});
        let scanPerKoin = parseInt(ConfigScan.scanPerKoin);
        let jedaKoin = parseInt(ConfigScan.jedaKoin);
        let jedaTimeGroup = parseInt(ConfigScan.jedaTimeGroup);
        let dexList = getFromLocalStorage("DEX_PILIH", []);

        let speedScan = parseInt(getFromLocalStorage('SavedSettingData.speedScan', 500)) * 1000; // Ambil speedScan dari localStorage, default 1000ms

        // Semaphore untuk membatasi jumlah request yang berjalan secara bersamaan
        let maxConcurrentRequests = scanPerKoin; // Sesuaikan dengan batasan yang diinginkan
        let currentRequests = 0;
        let requestQueue = [];

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function updateProgress(current, total, startTime, TokenPair) {
            let duration = ((Date.now() - startTime) / 1000 / 60).toFixed(2);
            let progressPercentage = Math.floor((current / total) * 100);
            let progressText = `CHECKING - ${TokenPair} [${current}/${total}] :: Mulai: ${new Date(startTime).toLocaleTimeString()} ~ DURASI [${duration} Menit]`;
            
            $('#progress-bar').css('width', progressPercentage + '%');
            $('#progress-text').text(progressPercentage + '%');
            $('#progress').text(progressText);
        }

        // panggil di awal aplikasi atau sebelum getPriceCEX
        async function processRequest(token) {
            currentRequests++;
            try {
                let cex = token.cex.toUpperCase();
                let symbolIn = token.symbol_in.toUpperCase();
                let symbolOut = token.symbol_out.toUpperCase();
                let sc_input = token.sc_in.toString();
                let sc_output = token.sc_out.toString();
                let des_input = token.des_in;
                let des_output = token.des_out;
                let NameToken = token.symbol_in.toUpperCase();
                let NamePair = token.symbol_out.toUpperCase();

                let TokenPair = `${symbolIn}_${symbolOut}`;
                let PairToken = `${symbolOut}_${symbolIn}`;

                await new Promise((resolve, reject) => {
                    let timeout = setTimeout(() => reject("Timeout"), speedScan);
                    //console.log("Detail TOKEN PAIR",token);
                    getPriceCEX(token, token.symbol_in, token.symbol_out, token.cex, (error, DataCEX) => {
                       // console.log(DataCEX);

                        clearTimeout(timeout);
                        let isInvalid = false;

                        // Ambil harga dari volume level 0 atau fallback ke 0 jika tidak ada
                        let priceBuyTokenCEX = DataCEX.volumes_buyToken?.[0]?.price || 0;
                        let priceSellTokenCEX = DataCEX.volumes_sellToken?.[0]?.price || 0;

                        let priceBuyPairCEX = DataCEX.volumes_buyPair?.[0]?.price || 0;
                        let priceSellPairCEX = DataCEX.volumes_sellPair?.[0]?.price || 0;

                        // Validasi harga-harga
                        if (!isFinite(priceBuyTokenCEX) || priceBuyTokenCEX <= 0) {
                            toastr.error(`Tidak Dapat Harga ${token.symbol_in} pada ${token.cex}`);
                            isInvalid = true;
                        }

                        if (!isFinite(priceSellTokenCEX) || priceSellTokenCEX <= 0) {
                            toastr.error(`Tidak Dapat Harga ${token.symbol_in} pada ${token.cex}`);
                            isInvalid = true;
                        }

                        if (!isFinite(priceBuyPairCEX) || priceBuyPairCEX <= 0) {
                            toastr.error(`Tidak Dapat Harga ${token.symbol_out} pada ${token.cex}`);
                            isInvalid = true;
                        }

                        if (!isFinite(priceSellPairCEX) || priceSellPairCEX <= 0) {
                            toastr.error(`Tidak Dapat Harga ${token.symbol_out} pada ${token.cex}`);
                            isInvalid = true;
                        }

                        // Jika error atau tidak valid, skip ke step berikutnya
                        if (error || !DataCEX || isInvalid) {
                            console.error("Error data from CEX:", error || "Data tidak valid");
                            toastr.error(`Cek ulang harga ${token.symbol_in}/${token.symbol_out} di ${token.cex}`);
                            resolve(); // lanjut ke iterasi berikutnya jika async dalam Promise
                            $('#' + token.cex + '_' + TokenPair + '_' + (DTChain.Nama_Chain).toUpperCase()).css('background-color', '#949191');
                            return;
                        }
                        else {
                            
                            const buyVolToken = (DataCEX.volumes_buyToken.length > 0) 
                                ? DataCEX.volumes_buyToken.reduce((min, item) => item.price < min.price ? item : min).volume 
                                : 1;

                            const sellVolPair = (DataCEX.volumes_sellToken.length > 0) 
                                ? DataCEX.volumes_sellToken.reduce((max, item) => item.price > max.price ? item : max).volume 
                                : 1;

                            dexList.forEach((dex) => {
                                let IdTokentoPair = `${cex}_${dex.toUpperCase()}_${TokenPair}_${(DTChain.Nama_Chain).toUpperCase()}`;
                                let IdPairtoToken = `${cex}_${dex.toUpperCase()}_${PairToken}_${(DTChain.Nama_Chain).toUpperCase()}`;
                                                               
                                let modalKiri = token.modal_kiri;
                                let modalKanan = token.modal_kanan;
                                let dextype = dex.toLowerCase();
                                
                                // Perhitungan untuk modal kiri dan kanan
                                var amount_in_token = parseFloat(modalKiri) / parseFloat(priceBuyTokenCEX);
                                var amount_in_pair = parseFloat(modalKanan) / parseFloat(priceBuyPairCEX);
                                
                                // dari KIRI / token to pair
                                if ($(`#${IdTokentoPair}`).length && $('input[type="checkbox"][value="Actionkiri"]').is(':checked')) {
                                     if (dextype === "lifi") {                                            
                                         var amount_in = Math.pow(10, des_input) * amount_in_token;
                                         getPriceSWOOP(sc_input, des_input, sc_output, des_output, amount_in, priceBuyPairCEX, dextype, NameToken, NamePair, cex,'TokentoPair', function (altError, altDataDEX){  
                                            if (!altError) {
                                                $(`#${IdTokentoPair}`).css('background-color', '#fbfefe');
                                                $(`span#LEFT_${IdTokentoPair}`).html(`<label title="${cex} BUY: USDT->${NameToken}"> ${formatPrice(priceBuyTokenCEX)}</label>`);
                                                $(`span#RIGHT_${IdTokentoPair}`).html(`<label title="${cex} SELL: ${NamePair}->USDT"> ${formatPrice(priceSellPairCEX)}</label>`);
                                                    ResultEksekusi(altDataDEX.amount_out,altDataDEX.FeeSwap,sc_input, sc_output, cex, modalKiri, amount_in_token, priceBuyTokenCEX, priceSellTokenCEX, priceBuyPairCEX, priceSellPairCEX, NameToken, NamePair,DataCEX.feeWDToken, dextype,'TokentoPair',buyVolToken);
                                            } else{
                                                // Jika error dari SWOOP adalah 500, maka larikan ke RUBIC
                                                console.log(altError);
                                                if (altError.statusCode == 500 || error.statusCode == 0 ) {
                                                    getPriceRUBIC(sc_input, des_input, sc_output, des_output, amount_in_token, priceBuyPairCEX, dextype, NameToken, NamePair, cex, 'TokentoPair', function (rubErr, rubData) {
                                                        if (!rubErr) {
                                                            $(`#${IdTokentoPair}`).css('background-color', '#bbcef2');
                                                            $(`span#LEFT_${IdTokentoPair}`).html(`<label title="${cex} BUY: USDT->${NameToken}"> ${formatPrice(priceBuyTokenCEX)}</label>`);
                                                            $(`span#RIGHT_${IdTokentoPair}`).html(`<label title="${cex} SELL: ${NamePair}->USDT"> ${formatPrice(priceSellPairCEX)}</label>`);
                                                            ResultEksekusi(rubData.amount_out, rubData.FeeSwap, sc_input, sc_output, cex, modalKiri, amount_in_token, priceBuyTokenCEX, priceSellTokenCEX, priceBuyPairCEX, priceSellPairCEX, NameToken, NamePair, DataCEX.feeWDToken, dextype, 'TokentoPair', buyVolToken);
                                                        } else {
                                                            $(`#${IdTokentoPair}`).css('background-color', rubErr.color || '#ffcccc');
                                                            $(`#SWAP_${IdTokentoPair}`).html(`${dex.toUpperCase()}<br/><a href="${rubErr.dexURL}" target="_blank">#</a><span title="TIDAK DAPAT HARGA DARI RUBIC">[ERROR RUBIC]</span>`);
                                                        }
                                                    });
                                                } else{
                                                        $(`#${IdTokentoPair}`).css('background-color',altError.color);
                                                        $(`#SWAP_${IdTokentoPair}`).html(`${dex.toUpperCase()} <br/><a href=${altError.dexURL} target="_blank" >#</a> <span title="TIDAK DAPAT HARGA">[ERROR]</span>`);
                                                }
                                            }
                                        });
                                    }else{
                                    getPriceDEX(sc_input, des_input, sc_output, des_output, amount_in_token, priceBuyPairCEX, dextype, NameToken, NamePair, cex,'TokentoPair', function (error, DataDEX) {
                                        if (error || !DataDEX) {
                                            $(`#${IdTokentoPair}`).css('background-color', error.color);
                                            $(`#SWAP_${IdTokentoPair}`).html(`${dex.toUpperCase()} <br/> <span <span class=uk-text-danger title="${error.pesanDEX}">[ERROR]</span>`);
                                              
                                                if ((error.statusCode == 0 && (dextype == "kyberswap" ))){
                                                 //    ||  (error.statusCode == 429 && dextype == "okx")){

                                                   // toastr.info(`${TokenPair} ${dextype} PINDAH SERVER`);
                                                    var amount_in = Math.pow(10, des_input) * amount_in_token;
                                                    getPriceSWOOP(sc_input, des_input, sc_output, des_output, amount_in, priceBuyPairCEX, dextype, NameToken, NamePair, cex,'TokentoPair', function (altError, altDataDEX){  
                                                        if (!altError) {
                                                            $(`#${IdTokentoPair}`).css('background-color', '#ded5d5');
                                                            $(`span#LEFT_${IdTokentoPair}`).html(`<label title="${cex} BUY: USDT->${NameToken}"> ${formatPrice(priceBuyTokenCEX)}</label>`);
                                                            $(`span#RIGHT_${IdTokentoPair}`).html(`<label title="${cex} SELL: ${NamePair}->USDT"> ${formatPrice(priceSellPairCEX)}</label>`);
                                                                ResultEksekusi(altDataDEX.amount_out,altDataDEX.FeeSwap,sc_input, sc_output, cex, modalKiri, amount_in_token, priceBuyTokenCEX, priceSellTokenCEX, priceBuyPairCEX, priceSellPairCEX, NameToken, NamePair,DataCEX.feeWDToken, dextype,'TokentoPair',buyVolToken);
                                                            }
                                                        else{
                                                                $(`#${IdTokentoPair}`).css('background-color',altError.color);
                                                                $(`#SWAP_${IdTokentoPair}`).html(`${dex.toUpperCase()} <br/> <span <span class=uk-text-danger title="${altError.pesanDEX}">[ERROR]</span>`);
                                                        }
                                                    });
                                                }

                                                if (dextype === "odos") {
                                                   // toastr.info(`${TokenPair} ${dextype} PINDAH SERVER`);
                                                    getPriceDEX(sc_input, des_input, sc_output, des_output, amount_in_token, priceBuyPairCEX, 'altodos', NameToken, NamePair, cex,'TokentoPair', function (altError, altDataDEX){  
                                                        if (!altError) {
                                                            $(`#${IdTokentoPair}`).css('background-color', '#ded5d5');
                                                            $(`span#LEFT_${IdTokentoPair}`).html(`<label title="${cex} BUY: USDT->${NameToken}"> ${formatPrice(priceBuyTokenCEX)}</label>`);
                                                            $(`span#RIGHT_${IdTokentoPair}`).html(`<label title="${cex} SELL: ${NamePair}->USDT"> ${formatPrice(priceSellPairCEX)}</label>`);
                                                                ResultEksekusi(altDataDEX.amount_out,altDataDEX.FeeSwap,sc_input, sc_output, cex, modalKiri, amount_in_token, priceBuyTokenCEX, priceSellTokenCEX, priceBuyPairCEX, priceSellPairCEX, NameToken, NamePair,DataCEX.feeWDToken, dextype,'TokentoPair',buyVolToken);
                                                            }
                                                        else{
                                                                $(`#${IdTokentoPair}`).css('background-color',altError.color);
                                                                $(`#SWAP_${IdTokentoPair}`).html(`${dex.toUpperCase()} <br/><a href=${altError.dexURL} target="_blank" >#</a> <span title="TIDAK DAPAT HARGA">[ERROR]</span>`);
                                                        }
                                                    });
                                                }

                                                if (dextype === "alt0x") {
                                                   // toastr.info(`${TokenPair} ${dextype} PINDAH SERVER`);
                                                    getPriceDEX(sc_input, des_input, sc_output, des_output, amount_in_token, priceBuyPairCEX, 'alt0x', NameToken, NamePair, cex,'TokentoPair', function (altError, altDataDEX){  
                                                        if (!altError) {
                                                            $(`#${IdTokentoPair}`).css('background-color', '#ded5d5');
                                                            $(`span#LEFT_${IdTokentoPair}`).html(`<label title="${cex} BUY: USDT->${NameToken}"> ${formatPrice(priceBuyTokenCEX)}</label>`);
                                                            $(`span#RIGHT_${IdTokentoPair}`).html(`<label title="${cex} SELL: ${NamePair}->USDT"> ${formatPrice(priceSellPairCEX)}</label>`);
                                                                ResultEksekusi(altDataDEX.amount_out,altDataDEX.FeeSwap,sc_input, sc_output, cex, modalKiri, amount_in_token, priceBuyTokenCEX, priceSellTokenCEX, priceBuyPairCEX, priceSellPairCEX, NameToken, NamePair,DataCEX.feeWDToken, dextype,'TokentoPair',buyVolToken);
                                                            }
                                                        else{
                                                                $(`#${IdTokentoPair}`).css('background-color',altError.color);
                                                                $(`#SWAP_${IdTokentoPair}`).html(`${dex.toUpperCase()} <br/><a href=${altError.dexURL} target="_blank" >#</a> <span title="TIDAK DAPAT HARGA">[ERROR]</span>`);
                                                        }
                                                    });
                                                }
                                            return;
                                        } else {
                                            // $(`#${IdTokentoPair}`).css('background-color', "#faf6f6");
                                                $(`span#LEFT_${IdTokentoPair}`).html(`<label title="${cex} BUY: USDT->${NameToken}"> ${formatPrice(priceBuyTokenCEX)}</label>`);
                                                $(`span#RIGHT_${IdTokentoPair}`).html(`<label title="${cex} SELL: ${NamePair}->USDT"> ${formatPrice(priceSellPairCEX)}</label>`);
                                                
                                                ResultEksekusi(DataDEX.amount_out,DataDEX.FeeSwap,sc_input, sc_output, cex, modalKiri, amount_in_token, priceBuyTokenCEX, priceSellTokenCEX, priceBuyPairCEX, priceSellPairCEX, NameToken, NamePair,DataCEX.feeWDToken, dextype,'TokentoPair',buyVolToken);
                                            
                                        }
                                    });
                                        }                               
                                    }

                                // pair to token / DARI KANAN
                                if ($(`#${IdPairtoToken}`).length && $('input[type="checkbox"][value="ActionKanan"]').is(':checked')) {
                                    if (dextype === "lifi") {
                                        // var amount_in = Math.pow(10, des_output) * amount_in_pair;
                                        //     getPriceSWOOP( sc_output, des_output,sc_input, des_input, amount_in, priceBuyPairCEX, dextype, NamePair, NameToken, cex,'PairtoToken', function (altError, altDataDEX){                                                                
                                        //         if (!altError) {
                                        //             $(`#${IdPairtoToken}`).css('background-color', '#fbfefe');
                                        //             $(`span#LEFT_${IdPairtoToken}`).html(`<label title="${cex} BUY: USDT->${NamePair}"> ${formatPrice(priceBuyPairCEX)}</label>`);
                                        //             $(`span#RIGHT_${IdPairtoToken}`).html(`<label title="${cex} SELL: ${NameToken}->USDT"> ${formatPrice(priceSellTokenCEX)}</label>`);

                                        //             ResultEksekusi(altDataDEX.amount_out,altDataDEX.FeeSwap,sc_output, sc_input, cex, modalKanan, amount_in_pair,  priceBuyPairCEX, priceSellPairCEX, priceBuyTokenCEX, priceSellTokenCEX, NamePair,NameToken, DataCEX.feeWDPair, dextype,'PairtoToken',sellVolPair);
                                        //         }else{
                                        //             $(`#${IdPairtoToken}`).css('background-color',altError.color);
                                        //             $(`#SWAP_${IdPairtoToken}`).html(`${dex.toUpperCase()} <br/><a href=${altError.dexURL} target="_blank" >#</a>  <span title="TIDAK DAPAT HARGA">[ERROR]</span>`)
                                        //         }
                                        //     });

                                        var amount_in = Math.pow(10, des_output) * amount_in_pair;
                                        getPriceSWOOP(sc_output, des_output, sc_input, des_input, amount_in, priceBuyPairCEX, dextype, NamePair, NameToken, cex, 'PairtoToken', function (altError, altDataDEX) {
                                            if (!altError) {
                                                $(`#${IdPairtoToken}`).css('background-color', '#fbfefe');
                                                $(`span#LEFT_${IdPairtoToken}`).html(`<label title="${cex} BUY: USDT->${NamePair}"> ${formatPrice(priceBuyPairCEX)}</label>`);
                                                $(`span#RIGHT_${IdPairtoToken}`).html(`<label title="${cex} SELL: ${NameToken}->USDT"> ${formatPrice(priceSellTokenCEX)}</label>`);
                                                ResultEksekusi(altDataDEX.amount_out, altDataDEX.FeeSwap, sc_output, sc_input, cex, modalKanan, amount_in_pair, priceBuyPairCEX, priceSellPairCEX, priceBuyTokenCEX, priceSellTokenCEX, NamePair, NameToken, DataCEX.feeWDPair, dextype, 'PairtoToken', sellVolPair);
                                            } else {
                                                // Jika error dari SWOOP adalah 500, fallback ke Rubic
                                                console.log(altError);
                                                if (altError.statusCode == 500 || altError.statusCode == 0) {
                                                    getPriceRUBIC(sc_output, des_output, sc_input, des_input, amount_in_pair, priceBuyPairCEX, dextype, NamePair, NameToken, cex, 'PairtoToken', function (rubErr, rubData) {
                                                        if (!rubErr) {
                                                            $(`#${IdPairtoToken}`).css('background-color', '#bbcef2');
                                                            $(`span#LEFT_${IdPairtoToken}`).html(`<label title="${cex} BUY: USDT->${NamePair}"> ${formatPrice(priceBuyPairCEX)}</label>`);
                                                            $(`span#RIGHT_${IdPairtoToken}`).html(`<label title="${cex} SELL: ${NameToken}->USDT"> ${formatPrice(priceSellTokenCEX)}</label>`);
                                                            ResultEksekusi(rubData.amount_out, rubData.FeeSwap, sc_output, sc_input, cex, modalKanan, amount_in_pair, priceBuyPairCEX, priceSellPairCEX, priceBuyTokenCEX, priceSellTokenCEX, NamePair, NameToken, DataCEX.feeWDPair, dextype, 'PairtoToken', sellVolPair);
                                                        } else {
                                                            $(`#${IdPairtoToken}`).css('background-color', rubErr.color || '#ffcccc');
                                                            $(`#SWAP_${IdPairtoToken}`).html(`${dex.toUpperCase()}<br/><a href="${rubErr.dexURL}" target="_blank">#</a><span title="TIDAK DAPAT HARGA DARI RUBIC">[ERROR RUBIC]</span>`);
                                                        }
                                                    });
                                                } else {
                                                    $(`#${IdPairtoToken}`).css('background-color', altError.color || '#ffcccc');
                                                    $(`#SWAP_${IdPairtoToken}`).html(`${dex.toUpperCase()} <br/><a href=${altError.dexURL} target="_blank">#</a>  <span title="TIDAK DAPAT HARGA">[ERROR]</span>`);
                                                }
                                            }
                                        });

                                    } else {
                                      getPriceDEX( sc_output, des_output,sc_input, des_input, amount_in_pair, priceBuyPairCEX, dextype, NamePair, NameToken, cex,'PairtoToken', function (error, DataDEX) {
                                    
                                        if (error || !DataDEX) {
                                            $(`#${IdPairtoToken}`).css('background-color', error.color);
                                            $(`#SWAP_${IdPairtoToken}`).html(`${dex.toUpperCase()} <br/> <span <span class=uk-text-danger title="${error.pesanDEX}">[ERROR]</span>`);
                                                
                                                    if ((error.statusCode == 0 && (dextype == "kyberswap"))) {
                                                    // toastr.info(`${PairToken} ${dextype} PINDAH SERVER`);
                                                        var amount_in = Math.pow(10, des_output) * amount_in_pair;
                                                        getPriceSWOOP( sc_output, des_output,sc_input, des_input, amount_in, priceBuyPairCEX, dextype, NamePair, NameToken, cex,'PairtoToken', function (altError, altDataDEX){                                                                
                                                            if (!altError) {
                                                                $(`#${IdPairtoToken}`).css('background-color', '#ded5d5');
                                                                $(`span#LEFT_${IdPairtoToken}`).html(`<label title="${cex} BUY: USDT->${NamePair}"> ${formatPrice(priceBuyPairCEX)}</label>`);
                                                                $(`span#RIGHT_${IdPairtoToken}`).html(`<label title="${cex} SELL: ${NameToken}->USDT"> ${formatPrice(priceSellTokenCEX)}</label>`);

                                                                ResultEksekusi(altDataDEX.amount_out,altDataDEX.FeeSwap,sc_output, sc_input, cex, modalKanan, amount_in_pair,  priceBuyPairCEX, priceSellPairCEX, priceBuyTokenCEX, priceSellTokenCEX, NamePair,NameToken, DataCEX.feeWDPair, dextype,'PairtoToken',sellVolPair);
                                                            }else{
                                                                $(`#${IdPairtoToken}`).css('background-color',altError.color);
                                                                $(`#SWAP_${IdPairtoToken}`).html(`${dex.toUpperCase()} <br/> <span <span class=uk-text-danger title="${altError.pesanDEX}">[ERROR]</span>`);
                                                            }
                                                        });
                                                }  
                                            
                                            if(dextype==="odos"){
                                                   // toastr.info(`${PairToken} ${dextype} PINDAH SERVER`);
                                                    getPriceDEX( sc_output, des_output,sc_input, des_input, amount_in_pair, priceBuyPairCEX, 'altodos', NamePair, NameToken, cex,'PairtoToken', function (altError, altDataDEX){                                                                
                                                        if (!altError) {
                                                            $(`#${IdPairtoToken}`).css('background-color', '#ded5d5');
                                                            $(`span#LEFT_${IdPairtoToken}`).html(`<label title="${cex} BUY: USDT->${NamePair}"> ${formatPrice(priceBuyPairCEX)}</label>`);
                                                            $(`span#RIGHT_${IdPairtoToken}`).html(`<label title="${cex} SELL: ${NameToken}->USDT"> ${formatPrice(priceSellTokenCEX)}</label>`);

                                                            ResultEksekusi(altDataDEX.amount_out,altDataDEX.FeeSwap,sc_output, sc_input, cex, modalKanan, amount_in_pair,  priceBuyPairCEX, priceSellPairCEX, priceBuyTokenCEX, priceSellTokenCEX, NamePair,NameToken, DataCEX.feeWDPair, dextype,'PairtoToken',sellVolPair);
                                                        }else{
                                                            $(`#${IdPairtoToken}`).css('background-color',altError.color);
                                                            $(`#SWAP_${IdPairtoToken}`).html(`${dex.toUpperCase()} <br/><a href=${altError.dexURL} target="_blank" >#</a>  <span title="TIDAK DAPAT HARGA">[ERROR]</span>`)
                                                        }
                                                });
                                            }

                                            if(dextype==="alt0x"){
                                                   // toastr.info(`${PairToken} ${dextype} PINDAH SERVER`);
                                                    getPriceDEX( sc_output, des_output,sc_input, des_input, amount_in_pair, priceBuyPairCEX, 'alt0x', NamePair, NameToken, cex,'PairtoToken', function (altError, altDataDEX){                                                                
                                                        if (!altError) {
                                                            $(`#${IdPairtoToken}`).css('background-color', '#ded5d5');
                                                            $(`span#LEFT_${IdPairtoToken}`).html(`<label title="${cex} BUY: USDT->${NamePair}"> ${formatPrice(priceBuyPairCEX)}</label>`);
                                                            $(`span#RIGHT_${IdPairtoToken}`).html(`<label title="${cex} SELL: ${NameToken}->USDT"> ${formatPrice(priceSellTokenCEX)}</label>`);

                                                            ResultEksekusi(altDataDEX.amount_out,altDataDEX.FeeSwap,sc_output, sc_input, cex, modalKanan, amount_in_pair,  priceBuyPairCEX, priceSellPairCEX, priceBuyTokenCEX, priceSellTokenCEX, NamePair,NameToken, DataCEX.feeWDPair, dextype,'PairtoToken',sellVolPair);
                                                        }else{
                                                            $(`#${IdPairtoToken}`).css('background-color',altError.color);
                                                            $(`#SWAP_${IdPairtoToken}`).html(`${dex.toUpperCase()} <br/><a href=${altError.dexURL} target="_blank" >#</a>  <span title="TIDAK DAPAT HARGA">[ERROR]</span>`)
                                                        }
                                                });
                                            }
                                            return;
                                        } 
                                        else {
                                           
                                        //$(`#${IdPairtoToken}`).css('background-color', "#faf6f6");
                                            $(`span#LEFT_${IdPairtoToken}`).html(`<label title="${cex} BUY: USDT->${NamePair}"> ${formatPrice(priceBuyPairCEX)}</label>`);
                                            $(`span#RIGHT_${IdPairtoToken}`).html(`<label title="${cex} SELL: ${NameToken}->USDT"> ${formatPrice(priceSellTokenCEX)}</label>`);
                                            ResultEksekusi(DataDEX.amount_out,DataDEX.FeeSwap,sc_output, sc_input, cex, modalKanan, amount_in_pair,  priceBuyPairCEX, priceSellPairCEX, priceBuyTokenCEX, priceSellTokenCEX, NamePair,NameToken, DataCEX.feeWDPair, dextype,'PairtoToken',sellVolPair);
                                        }
                                        
                                    });
                                        }
                                    }
                                
                            });

                            resolve();
                        }
                    });
                });

                await delay(jedaKoin);
            } catch (error) {
                console.error(`Kesalahan saat memproses ${token.symbol_in}_${token.symbol_out}:`, error);
            } finally {
                currentRequests--;
                if (requestQueue.length > 0) {
                    let nextRequest = requestQueue.shift();
                    nextRequest();
                }
            }
        }

        async function processTokens() {
            let startTime = Date.now();
            let totalTokens = filteredTokens.length;
            let currentProcessed = 0;

            let tokenGroups = [];
            for (let i = 0; i < filteredTokens.length; i += scanPerKoin) {
                tokenGroups.push(filteredTokens.slice(i, i + scanPerKoin));
            }

            for (let groupIndex = 0; groupIndex < tokenGroups.length; groupIndex++) {
                let groupTokens = tokenGroups[groupIndex];
                console.log(`Memproses grup ${groupIndex + 1} dari ${tokenGroups.length}`);

                feeGasGwei();
                getRateUSDT();

                for (let tokenIndex = 0; tokenIndex < groupTokens.length; tokenIndex++) {
                    let token = groupTokens[tokenIndex];

                    updateProgress(
                        currentProcessed + tokenIndex + 1,
                        totalTokens,
                        startTime,
                        `${token.symbol_in}_${token.symbol_out}`
                    );

                    if (currentRequests >= maxConcurrentRequests) {
                        await new Promise(resolve => requestQueue.push(resolve));
                    }

                    await processRequest(token);
                }

                currentProcessed += groupTokens.length;
                console.log(`Grup ${groupIndex + 1} selesai diproses`);
                await delay(jedaTimeGroup);
            }

            // Tampilkan progres 100%
            updateProgress(totalTokens, totalTokens, startTime, "SELESAI");

            form_on();
            $("#stopSCAN").hide().prop("disabled", false);
            $("#LoadDataBtn, #SettingModal, #MasterData, #UpdateWalletCEX, #chain-links-container")
                .css("pointer-events", "auto")
                .css("opacity", "1");

            // ✅ Jalankan ulang hanya jika scan sudah complete dan autorun aktif
           
            if ($('#autorun').prop('checked')) {
                let countdown = 10;
                $('#progress-text').text(`Restarting in ${countdown}s...`);
                $('#bar').css('width', '0%');
               
                // ⏳ Jalankan countdown mundur 10s
                const countdownInterval = setInterval(() => {
                    countdown--;
                    $('#progress-text').text(`Restarting in ${countdown}s...`);
                    if (countdown <= 0) {
                        clearInterval(countdownInterval);
                        console.log("Memulai ulang proses scan karena autorun aktif...");
                        toastr.info("MEMULAI SCAN LAGI!");

                        cekDataAwal();
                        $('#sinyal-container span[id^="sinyal"]').empty();
                        form_off();
                        $("#stopSCAN").show().prop('disabled', false);
                        $('#LoadDataBtn, #SettingModal, #MasterData, #UpdateWalletCEX, #chain-links-container')
                            .css('pointer-events', 'none')
                            .css('opacity', '0.4');
                        $('.statusCheckbox').css({ 'pointer-events': 'auto', 'opacity': '1' }).prop('disabled', false);

                        processTokens(); // Mulai ulang scan
                    }
                }, 1000);
            } else {
                $('#progress-text').html("SCAN COMPLETE");
            }

        }

        processTokens();
    });
  
    //genereta inputan checkbox
    function generateInputCheckbox(items, containerId, idPrefix, labelText, style) {
        const $container = $(`#${containerId}`);
        $container.empty(); // Bersihkan container

        // Variabel untuk jumlah token (khusus untuk cex-options)
        let jml = 0;
        // Hitung jumlah token hanya jika containerId adalah "cex-options"
        if (containerId === "cex-options") {
            jml = filteredTokens.filter(t => t.status === true && items.includes(t.cex)).length;
        }
   
        // Tambahkan label di atas checkbox
        const label = `
            <b>
                <span class="uk-text-secondary uk-text-medium">
                    ${labelText}
                </span>
            </b>
        `;
        $container.append(label);

        // Jika `items` adalah objek, ubah menjadi array key
        if (typeof items === 'object' && !Array.isArray(items)) {
            items = Object.keys(items); // Ambil key dari objek
        }

        // Iterasi dan tambahkan checkbox beserta label
        const checkboxWrapper = $('<div style="display: flex; flex-wrap: wrap; gap: 10px;"></div>'); // Bungkus checkbox
        items.forEach(item => {
            const checkboxId = `${idPrefix}${item.toUpperCase()}`;

            const countForCEX = containerId === "cex-options" 
                ? filteredTokens.filter(t => t.status === true && t.cex === item).length 
                /*  && t.depositPair === true && t.withdrawToken === true && t.depositToken === true && t.withdrawPair === true).length */
                : ""; // Hanya hitung jumlah token untuk cex-options
            const checkbox = `
                <label class="${style || ''}" for="${checkboxId}">
                    <input type="checkbox" id="${checkboxId}" value="${item}" checked>
                    ${item.toUpperCase()}${containerId === "cex-options" ? ` (${countForCEX})` : ""}
                </label>`;
            checkboxWrapper.append(checkbox);
        });

        $container.append(checkboxWrapper); // Masukkan checkbox ke dalam container
    }

    // Fungsi untuk memuat data dari localStorage saat halaman dimuat
    function loadCheckboxSelections() {
        let errorMessages = [];
        // Muat data CEX
        const savedCEX = getFromLocalStorage("CEX_PILIH", []);
        $('#cex-options input[type="checkbox"]').each(function() {
            $(this).prop('checked', savedCEX.includes($(this).val()));
        });
        // Muat data DEX
        const savedDEX = getFromLocalStorage("DEX_PILIH", []);
        $('#dex-options input[type="checkbox"]').each(function() {
            $(this).prop('checked', savedDEX.includes($(this).val()));
        });

        // Muat data DEXPAIR
        const savedDEXPAIR = getFromLocalStorage("DEXPAIR_PILIH", []);
        $('#dexpair-options input[type="checkbox"]').each(function() {
            $(this).prop('checked', savedDEXPAIR.includes($(this).val()));
        });

      //  const pilihCex = getFromLocalStorage('CEX_PILIH', null);
        if (!savedCEX || !Array.isArray(savedCEX) || savedCEX.length === 0) {
            errorMessages.push('SILAKAN PILIH CEX!');
            $("#cex-options").addClass("error");
            form_on(); // tetap off jika `PILIH_CEX` belum diatur
        }
        
        //const pilihDex = getFromLocalStorage('DEX_PILIH', null);
        if (!savedDEX || !Array.isArray(savedDEX) || savedDEX.length === 0) {
            errorMessages.push('SILAKAN PILIH DEX!');
            $("#dex-options").addClass("error");
            form_on(); // tetap off jika `PILIH_DEX_PAIR` belum diatur
        }  
       // const pilihDexPair = getFromLocalStorage('DEXPAIR_PILIH', null);
        if (!savedDEXPAIR || !Array.isArray(savedDEXPAIR) || savedDEXPAIR.length === 0) {
            errorMessages.push('SILAKAN PILIH DEX PAIR!');
            $("#dexpair-options").addClass("error");
            form_on(); // tetap off jika `PILIH_DEX_PAIR` belum diatur
        }   
        $("#InfoAPP").html(errorMessages.join('<br/>')).addClass("text-large");    
    }
   
    $("#strictFilter").on("change", function() {
        var useStrictFilter = $(this).is(":checked");
        console.log("CLOSE WALLET DEX:", useStrictFilter);
    });

    // Fungsi untuk menentukan warna berdasarkan nama CEX
    function getWarnaCEX(cex) {
        const cexConfig = CONFIG_CEX[cex.toUpperCase()]; // Ambil konfigurasi berdasarkan nama CEX
        return cexConfig && cexConfig.WARNA ? cexConfig.WARNA : 'black'; // Gunakan warna dari konfigurasi atau 'black' jika tidak ditemukan
    }

    // Fungsi untuk menampilkan sinyal DEX
    function loadSignalData() {
        let selectedDEX = getFromLocalStorage('DEX_PILIH', []); // Ambil pilihan DEX dari localStorage
        const appSettings = getFromLocalStorage('DATA_SETTING', {});

        let sinyalContainer = document.getElementById('sinyal-container');
        sinyalContainer.innerHTML = ''; // Kosongkan sebelumnya jika ada perubahan

        selectedDEX.forEach(dex => {
            const modalName = appSettings[`MODAL_${dex.toUpperCase()}`] || 0;
            // Menambahkan elemen sinyal untuk setiap DEX yang dipilih
            let sinyalItem = document.createElement('div');
            sinyalItem.classList.add('sinyal-item');
            sinyalItem.setAttribute('data-dex', `${dex}`);

            let label = document.createElement('b');
            label.innerText = dex.toUpperCase(); // Menampilkan nama DEX

            let signalSpan = document.createElement('span');
            signalSpan.classList.add('uk-text', 'uk-text-small', 'uk-text-primary');
            signalSpan.setAttribute('id', `sinyal${dex.toLowerCase()}`); // ID dinamis untuk sinyal setiap DEX

            sinyalItem.appendChild(label);
            sinyalItem.innerHTML += ` : `; // Separator
            sinyalItem.appendChild(signalSpan);

            sinyalContainer.appendChild(sinyalItem);
        });
    }
    
    function createLink(url, text, className = '') {
        return url
            ? `<a href="${url}" target="_blank" class="${className}"><b>${text}</b></a>`
            : `<b>${text}</b>`;
    }
    // Menampilkan Semua DETAIL TOKEN PAIR dalam tabel
    function loadStoredData(filteredData) {
        $('.table-header th').css('background-color', DTChain.COLOR_CHAIN);
        loadSignalData();
       // console.warn("KOIN FILTERING",filteredData);
        const selectedDEX = getFromLocalStorage('DEX_PILIH', []);
        const appSettings = getFromLocalStorage('DATA_SETTING', {});
        const $InfoStatus = $('#InfoStatus');
        const $tableBody = $('#dataTableBody');
        const $headerRow = $('.table-header');

        $InfoStatus.text("Sedang Memuat DATA TOKEN...").show();

        if (!Array.isArray(filteredData) || filteredData.length === 0) {
            $InfoStatus.text("Tidak ada data token yang ditemukan.");
            setTimeout(() => $InfoStatus.fadeOut(), 2000);
            return;
        }

        // Kosongkan tabel dengan lebih efisien
        while ($tableBody.firstChild) {
            $tableBody.removeChild($tableBody.firstChild);
        }

        $tableBody.empty(); 
        // Optimasi Header dengan Fragment
        if ($headerRow.children().length !== selectedDEX.length + 4) {
            const headerFragment = document.createDocumentFragment();
            $headerRow.empty();

            // Kolom pertama
            let th = document.createElement('th');
            th.className = 'header';
            th.textContent = 'PRICE & VOL BUY';
            headerFragment.appendChild(th);

            // Kolom DEX untuk sisi kiri (BUY)
            selectedDEX.forEach(dex => {
                const dexUpper = dex.toUpperCase();
                const modalKiri = appSettings[`MODAL_KIRI_${dexUpper}`] || 0;

                let th = document.createElement('th');
                th.className = 'header';
                th.textContent = `${dex} `; // Tampilkan modal kiri
                headerFragment.appendChild(th);
            });

            // Kolom tengah
            th = document.createElement('th');
            th.className = 'header';
            th.textContent = 'DETAIL TOKEN';
            headerFragment.appendChild(th);

            // Kolom DEX untuk sisi kanan (SELL)
            selectedDEX.forEach(dex => {
                const dexUpper = dex.toUpperCase();
                const modalKanan = appSettings[`MODAL_KANAN_${dexUpper}`] || 0;

                let th = document.createElement('th');
                th.className = 'header';
                th.textContent = `${dex} `; // Tampilkan modal kanan
                headerFragment.appendChild(th);
            });

            // Kolom terakhir
            th = document.createElement('th');
            th.className = 'header';
            th.textContent = 'PRICE & VOL SELL';
            headerFragment.appendChild(th);

            $headerRow.append(headerFragment);
        }

        const fragment = document.createDocumentFragment();

        filteredData.forEach((data, index) => {
            const warnaCEX = getWarnaCEX(data.cex);
            const urlsCEX = GeturlExchanger(data.cex, data.symbol_in, data.symbol_out);
            const urlsCEXToken = GeturlExchanger(data.cex, data.symbol_in, data.symbol_in);
            const urlsCEXPair = GeturlExchanger(data.cex, data.symbol_out, data.symbol_out);

            // Status withdraw dan deposit dengan link
            const withdrawToken = data.withdrawToken ? createLink(urlsCEXToken.withdrawUrl, 'WD') : `<b style="color:red; font-weight:bold;">WX</b>`;
            const depositToken = data.depositToken ? createLink(urlsCEXToken.depositUrl, 'DP') : `<b style="color:red; font-weight:bold;">DX</b>`;

            const withdrawPair = data.withdrawPair ? createLink(urlsCEXPair.withdrawUrl, 'WD') : `<b style="color:red; font-weight:bold;">WX</b>`;
            const depositPair = data.depositPair ? createLink(urlsCEXPair.depositUrl, 'DP') : `<b style="color:red; font-weight:bold;">DX</b>`;

            // Link untuk SC dan stok token pair
            const linkToken = createLink(urlsCEX.tradeToken, data.symbol_in.toUpperCase());
            const linkPair = createLink(urlsCEX.tradePair, data.symbol_out.toUpperCase());
            
            const linkStokToken = Object.keys(DTChain.CEXCHAIN[data.cex])
                .filter((key) => key.includes('address'))
                .map((key, idx) => createLink(`${DTChain.URL_Chain}/token/${data.sc_in}?a=${DTChain.CEXCHAIN[data.cex][key]}`, `#${idx + 1} `))
                .join('');

            const linkStokPair = Object.keys(DTChain.CEXCHAIN[data.cex])
                .filter((key) => key.includes('address'))
                .map((key, idx) => createLink(`${DTChain.URL_Chain}/token/${data.sc_out}?a=${DTChain.CEXCHAIN[data.cex][key]}`, `#${idx + 1} `))
                .join('');

            // Link DEX
            let chainName = DTChain.Nama_Chain.toUpperCase();
            if (DTChain.Nama_Chain === "ethereum") {
                chainName = "ETH";
            }

            let chainName2 = DTChain.Nama_Chain.toLowerCase();
            if (DTChain.Nama_Chain === "bsc") {
                chainName2 = "bnb";
            }

            //https://app.rubic.exchange/?fromChain=ETH&toChain=ETH&from=VIB&to=ETH
            const linkOKDEX = createLink(`https://www.okx.com/web3/dex-swap?inputChain=${DTChain.Kode_Chain}&inputCurrency=${data.sc_in}&outputChain=501&outputCurrency=${data.sc_out}`, '#OK', 'uk-text-secondary');
            const linkUNIDEX = createLink(`https://app.unidex.exchange/?chain=${DTChain.Nama_Chain}&from=${data.sc_in}&to=${data.sc_out}`, '#UN', 'uk-text-warning');
            const linkRango = createLink(`https://app.rango.exchange/bridge?fromBlockchain=${chainName}&toBlockchain=${chainName}&fromToken=${data.symbol_in}--${data.sc_in}&toToken=${data.symbol_out}--${data.sc_out}`, '#RX', 'uk-text-success');
            const linkRBX = createLink(`https://app.rubic.exchange/?fromChain=${chainName}&toChain=${chainName}&from=${data.sc_in}&to=${data.sc_out}`, '#RBCX', 'uk-text-warning');
            const linkDEFIL = createLink(`https://swap.defillama.com/?chain=${DTChain.Nama_Chain}&from=${data.sc_in}&to=${data.sc_out}`, '#DF', 'uk-text-primary');
            const OPEN = createLink(` https://app.openocean.finance/swap/${DTChain.Nama_Chain}/${data.symbol_in}/${data.symbol_out}`, '#OPEN', 'uk-text-danger');
            const FINCH = createLink(`https://app.1inch.io/swap?src=${DTChain.Kode_Chain}:${data.symbol_in}&dst=${DTChain.Kode_Chain}:${data.symbol_out}`, '#1INCH', 'uk-text-warning');
            const linkRelay = createLink(`https://relay.link/bridge/${chainName2}?fromChainId=${DTChain.Kode_Chain}&fromCurrency=${data.sc_in}&toCurrency=${data.sc_out}`, '#RX', 'uk-text-warning');
            const linkLiFi = createLink(`https://jumper.exchange/?fromChain=${DTChain.Kode_Chain}&fromToken=${data.sc_in}&toChain=${DTChain.Kode_Chain}&toToken==${data.sc_out}`, '#LF', 'uk-text-warning');
            const Link1INCH = createLink(`https://app.1inch.io/advanced/swap?network=${DTChain.Kode_Chain}&src=${data.sc_in}&dst=${data.sc_out}`, '#1NC', 'uk-text-danger');

            let row = document.createElement('tr');
            row.dataset.index = index;
            row.id = `${data.cex}_${data.symbol_in}_${data.symbol_out}_${DTChain.Nama_Chain.toUpperCase()}`;

            row.innerHTML = `
                <td style="text-align:center; vertical-align: middle;" class="uk-text-success">
                    <span id="LEFT_${data.cex}_${data.symbol_in}_${data.symbol_out}_${DTChain.Nama_Chain.toUpperCase()}">PRICE & VOL BUY <br>${data.cex}</span>
                </td>
            `;

            selectedDEX.forEach(dex => {
                const idCELL = `${data.cex}_${dex.toUpperCase()}_${data.symbol_in}_${data.symbol_out}_${DTChain.Nama_Chain.toUpperCase()}`;
                let td = document.createElement('td');
                td.className = 'uk-text-center';
                td.style.verticalAlign = 'middle';
                td.id = idCELL;
                td.innerHTML = `
                    <a href="#"><span class="buy" id="LEFT_${idCELL}" title="LEFT_${idCELL}">  </span></a><br>
                    <span class="uk-text-primary uk-text-bolder" id="SWAP_${idCELL}">  </span><br>
                    <a href="#"><span class="sell" id="RIGHT_${idCELL}" title="RIGHT_${idCELL}">  </span></a><br>
                    <hr class="uk-divider-small uk-margin-remove">
                    <span class="uk-text-primary" id="RESULT_${idCELL}">  </span>
                `;
                row.appendChild(td);
            });

            let detailTd = document.createElement('td');
            detailTd.className = 'uk-text-center uk-background uk-text-nowrap';

            detailTd.innerHTML = `
               #${index+1}  <span style="color: ${warnaCEX}; font-weight:bolder;">${data.cex}  </span><br/>
               <span class="uk-text-primary uk-text-bolder">${data.modal_kiri}$</span> <=> <span class="uk-text-danger uk-text-bolder">${data.modal_kanan}$</span><br/>
                 <span class="uk-text-secondary uk-text-bolder">${linkToken} VS ${linkPair}</span>
                 <span id="DelAuto-${index}" data-index="${index}" uk-icon="icon: minus-circle; ratio: 0.8"  class="uk-text-danger uk-text-bolder"  style="cursor:pointer"> </span><br/>
               <span class="uk-text-primary uk-text-bolder">${withdrawToken}~${depositToken}</span> | <span class="uk-text-primary uk-text-bolder">${withdrawPair}~${depositPair}</span> <br/>
               
                <span class="uk-text-primary uk-text-bolder">${data.symbol_in}</span> 
                <a href="${DTChain.URL_Chain}/token/${data.sc_in}" target="_blank" class="uk-link">[SC]</a>: ${linkStokToken}<br>    
                <span class="uk-text-primary uk-text-bolder">${data.symbol_out}</span> 
                <a href="${DTChain.URL_Chain}/token/${data.sc_out}" target="_blank" class="uk-link">[SC]</a>: ${linkStokPair}<br>                   
               ${linkUNIDEX} ${linkOKDEX} ${linkDEFIL} ${Link1INCH} ${linkRango}
            `;

            row.appendChild(detailTd);

            selectedDEX.forEach(dex => {
                const idCELL = `${data.cex}_${dex.toUpperCase()}_${data.symbol_out}_${data.symbol_in}_${DTChain.Nama_Chain.toUpperCase()}`;
                let td = document.createElement('td');
                td.className = 'uk-text-center';
                td.style.verticalAlign = 'middle';
                td.id = idCELL;
                td.innerHTML = `
                    <a href="#"><span class="buy" id="LEFT_${idCELL}" title="LEFT_${idCELL}">  </span></a><br>
                    <span class="uk-text-primary uk-text-bolder" id="SWAP_${idCELL}">  </span><br>
                    <a href="#"><span class="sell" id="RIGHT_${idCELL}" title="RIGHT_${idCELL}">  </span></a><br>
                    <hr class="uk-divider-small uk-margin-remove">
                    <span class="uk-text-primary" id="RESULT_${idCELL}">  </span>
                `;
                row.appendChild(td);
            });

            row.innerHTML += `
                <td style="text-align:center; vertical-align: middle;" class="uk-text-danger">
                    <span id="RIGHT_${data.cex}_${data.symbol_in}_${data.symbol_out}_${DTChain.Nama_Chain.toUpperCase()}">PRICE & VOL SELL <br>${data.cex}</span>
                </td>
            `;

            fragment.appendChild(row);
        });

        $tableBody.append(fragment);

        $('#tokenCount').text(`(${filteredData.length})`);

        $InfoStatus.text("SELESAI, Memuat DATA TOKEN !!");
        if (selectedDEX.length <= 6) {
            $("#startSCAN").show();
        }else{
            alert("❌ MAX 6 DEX, SILAKAN KURANGI!! ❌");
            return; // Hentikan proses jika lebih dari 4 DEX
        }

        setTimeout(() => $InfoStatus.fadeOut(), 2000);

        $(".table-header th").css({
            "background-color": selectedChain.WARNA,
            "color": "white",
            "position": "sticky",
            "font-size":"12.5px",
            "top": "0",
            "font-weight": "bolder",
            "text-align": "center",
            "z-index": "10"
        });

        updateSortIcons();
    }

    //FUNGSI ubah status tokenpair
    $(document).on('change', '.statusCheckbox', function (event) {
        event.preventDefault();
        const id = $(this).data('id');
        const no = $(this).data('index');
        const isChecked = $(this).prop('checked');
        const storedData = getFromLocalStorage('TOKEN_FAV_SCANNER', []);
        const selectedCEX = getFromLocalStorage('CEX_PILIH', []); // Ambil selectedCEX dari localStorage
        const token = storedData.find(t => t.no === no);

        if (token) {
            token.status = isChecked;
            saveToLocalStorage('TOKEN_FAV_SCANNER', storedData);

            // Hitung ulang jumlah total token aktif
            const jml = storedData.filter(item => 
                item.status === true /* && 
                item.depositPair === true && 
                item.withdrawToken === true && 
                item.depositToken === true && 
                item.withdrawPair === true
                */
            ).length;

            $(`td[data-index="${id}"]`).remove();
            $('tr[data-index="' + id + '"]').hide();
            // Perbarui elemen yang menampilkan total ALL token
            $('#tokenCountALL').text(`TOTAL SEMUA : ${jml} PAIR-TOKEN`);

            // Hitung ulang jumlah token per CEX
            const savedCexs = [...new Set(storedData.map(t => t.cex))]; // Ambil daftar CEX unik
            const tokenCounts = savedCexs.reduce((acc, cex) => {
                acc[cex] = storedData.filter(t => t.cex === cex && t.status === true).length;
               /* && t.depositPair === true && t.withdrawToken === true && t.depositToken === true && t.withdrawPair === true).length;*/
                return acc;
            }, {});

            // Perbarui jumlah token dan status checkbox di cex-options
            savedCexs.forEach(cex => {
                const countText = ` (${tokenCounts[cex] || 0})`;
                const isCheckedCEX = selectedCEX.includes(cex); // Cek apakah cex termasuk dalam selectedCEX
                $(`#cex-options label:contains(${cex.toUpperCase()})`).each(function () {
                    const labelText = $(this).text().split('(')[0].trim(); // Ambil teks label sebelum tanda kurung
                    $(this).html(`
                        <input type="checkbox" value="${cex}" ${isCheckedCEX ? 'checked' : ''}>
                        ${labelText}${countText}
                    `);
                });
            });

            toastr.info(`Berhasil mengubah status PAIR ${token.symbol_in}-${token.symbol_out}!`);
        }
    });

    //generate url cex
    function GeturlExchanger(cex, NameToken, NamePair) {
        // Konversi nama token dan pasangan ke uppercase
        const token = NameToken.toUpperCase();
        const pair = NamePair.toUpperCase();

        let baseUrlTradeToken = token === "USDT" ? "#" : null;
        let baseUrlTradePair = pair === "USDT" ? "#" : null;
        let baseUrlWithdraw = null;
        let baseUrlDeposit = null;

        // Menentukan URL berdasarkan nilai cex
        if (cex === "GATE") {
            if (baseUrlTradeToken !== "#") baseUrlTradeToken = `https://www.gate.com/trade/${token}_USDT`;
            if (baseUrlTradePair !== "#") baseUrlTradePair = `https://www.gate.com/trade/${pair}_USDT`;
            baseUrlWithdraw = `https://www.gate.com/myaccount/withdraw/${token}`;
            baseUrlDeposit = `https://www.gate.com/myaccount/deposit/${pair}`;
        } else if (cex === "BINANCE") {
            if (baseUrlTradeToken !== "#") baseUrlTradeToken = `https://www.binance.com/en/trade/${token}_USDT`;
            if (baseUrlTradePair !== "#") baseUrlTradePair = `https://www.binance.com/en/trade/${pair}_USDT`;
            baseUrlWithdraw = `https://www.binance.com/en/my/wallet/account/main/withdrawal/crypto/${token}`;
            baseUrlDeposit = `https://www.binance.com/en/my/wallet/account/main/deposit/crypto/${pair}`;
        } else if (cex === "KUCOIN") {
            if (baseUrlTradeToken !== "#") baseUrlTradeToken = `https://www.kucoin.com/trade/${token}-USDT`;
            if (baseUrlTradePair !== "#") baseUrlTradePair = `https://www.kucoin.com/trade/${pair}-USDT`;
            baseUrlWithdraw = `https://www.kucoin.com/assets/withdraw/${token}`;
            baseUrlDeposit = `https://www.kucoin.com/assets/coin/${pair}`;
        } else if (cex === "BITGET") {
            if (baseUrlTradeToken !== "#") baseUrlTradeToken = `https://www.bitget.com/spot/${token}USDT`;
            if (baseUrlTradePair !== "#") baseUrlTradePair = `https://www.bitget.com/spot/${pair}USDT`;
            baseUrlWithdraw = `https://www.bitget.com/asset/withdraw`;
            baseUrlDeposit = `https://www.bitget.com/asset/recharge`;
        } else if (cex === "BYBIT") {
            if (baseUrlTradeToken !== "#") baseUrlTradeToken = `https://www.bybit.com/en/trade/spot/${token}/USDT`;
            if (baseUrlTradePair !== "#") baseUrlTradePair = `https://www.bybit.com/en/trade/spot/${pair}/USDT`;
            baseUrlWithdraw = "https://www.bybit.com/user/assets/withdraw";
            baseUrlDeposit = "https://www.bybit.com/user/assets/deposit";
        } else if (cex === "MEXC") {
            if (baseUrlTradeToken !== "#") baseUrlTradeToken = `https://www.mexc.com/exchange/${token}_USDT?_from=search`;
            if (baseUrlTradePair !== "#") baseUrlTradePair = `https://www.mexc.com/exchange/${pair}_USDT?_from=search`;
            baseUrlWithdraw = `https://www.mexc.com/assets/withdraw/${token}`;
            baseUrlDeposit = `https://www.mexc.com/assets/deposit/${pair}`;
        } else if (cex === "OKX") {
            if (baseUrlTradeToken !== "#") baseUrlTradeToken = `https://www.okx.com/trade-spot/${token}-usdt`;
            if (baseUrlTradePair !== "#") baseUrlTradePair = `https://www.okx.com/trade-spot/${pair}-usdt`;
            baseUrlWithdraw = `https://www.okx.com/balance/withdrawal/${token}-chain`;
            baseUrlDeposit = `https://www.okx.com/balance/recharge/${pair}`;
        }
        else if (cex === "BITMART") {
            if (baseUrlTradeToken !== "#") baseUrlTradeToken = `https://www.bitmart.com/trade/en-US?symbol=${token}_USDT&type=spot`;
            if (baseUrlTradePair !== "#") baseUrlTradePair = `https://www.bitmart.com/trade/en-US?symbol=${pair}_USDT&type=spot`;
            baseUrlWithdraw = `https://www.bitmart.com/asset-withdrawal/en-US`;
            baseUrlDeposit = `https://www.bitmart.com/asset-deposit/en-US`;
        }
        else if (cex === "INDODAX") {
            if (baseUrlTradeToken !== "#") baseUrlTradeToken = `https://indodax.com/market/${token}IDR`;
            if (baseUrlTradePair !== "#") baseUrlTradePair = `https://indodax.com/market/${pair}IDR`;
            baseUrlWithdraw = `https://indodax.com/finance/${token}#kirim`;
            baseUrlDeposit = `https://indodax.com/finance/${token}`;
        }

        // Kembalikan objek URL
        return {
            tradeToken: baseUrlTradeToken,
            tradePair: baseUrlTradePair,
            withdrawUrl: baseUrlWithdraw,
            depositUrl: baseUrlDeposit
        };
    }

    // Menampilkan form settingan
    $("#SettingModal").on("click", function () {
        UIkit.modal("#modal-setting").show(); // Tampilkan modal
        let appSettings = getFromLocalStorage('DATA_SETTING', {}); // Ambil data setting

        const dexList = DTChain.DEXS || [];

        function loadSettings() {
            // Panggil generateInputModal versi dua modal (kiri & kanan)
            generateInputModal(dexList); // pastikan ini versi dua input

            // Isi nilai modal kiri & kanan
            dexList.forEach((dex) => {
                const dexUpper = dex.toUpperCase();
                const kiri = appSettings[`MODAL_KIRI_${dexUpper}`] || "0";
                const kanan = appSettings[`MODAL_KANAN_${dexUpper}`] || "0";

                $(`#ModalKiri${dexUpper}`).val(kiri);
                $(`#ModalKanan${dexUpper}`).val(kanan);
            });

            // Setting umum lainnya
            $('#user').val(appSettings.nickname || '');
            $('#inFilterPNL').val(appSettings.filterPNL || 0);
            $('#jeda-time-group').val(appSettings.jedaTimeGroup || 400);
            $('#jeda-koin').val(appSettings.jedaKoin || 200);
            $('#walletMeta').val(appSettings.walletMeta || '');
            $('#speedScan').val(appSettings.speedScan || 4);

            $(`input[name="koin-group"][value="${appSettings.scanPerKoin || 10}"]`).prop('checked', true);
            $(`input[name="waktu-tunggu"][value="${appSettings.speedScan || 4}"]`).prop('checked', true);
        }

        loadSettings();
    });

        // SIMPAN SETTING
    $('#save-config').on('click', function () {
        let nickname = $('#user').val();
        let filterPNL = $('#inFilterPNL').val();
        let jedaTimeGroup = $('#jeda-time-group').val();
        let jedaKoin = $('#jeda-koin').val();
        let walletMeta = $('#walletMeta').val();

        if (!nickname || !filterPNL || !jedaTimeGroup || !jedaKoin || !walletMeta) {
            alert('SEMUA HARUS DIISI!');
            return;
        }

        let scanPerKoin = $('input[name="koin-group"]:checked').val();
        let speedScan = $('input[name="waktu-tunggu"]:checked').val();

        let dexData = {};
        DTChain.DEXS.forEach(dex => {
            let dexUpper = dex.toUpperCase();
            let modalKiri = $(`#ModalKiri${dexUpper}`).val();
            let modalKanan = $(`#ModalKanan${dexUpper}`).val();

            if (modalKiri !== undefined) {
                dexData[`MODAL_KIRI_${dexUpper}`] = modalKiri;
            }
            if (modalKanan !== undefined) {
                dexData[`MODAL_KANAN_${dexUpper}`] = modalKanan;
            }
        });

        // Ambil data lama
        let oldData = getFromLocalStorage('DATA_SETTING', {});

        // Gabungkan data lama dan baru
        let appSettings = {
            ...oldData,
            ...dexData,
            nickname: nickname,
            filterPNL: filterPNL,
            jedaTimeGroup: jedaTimeGroup,
            jedaKoin: jedaKoin,
            walletMeta: walletMeta,
            scanPerKoin: scanPerKoin,
            speedScan: speedScan
        };

        saveToLocalStorage('DATA_SETTING', appSettings);

        UIkit.modal("#modal-setting").hide();
        alert("SIMPAN SETTING APLIKASI BERHASIL!!");
        location.reload();
    });

    $(document).on('change', '#cex-options input[type="checkbox"], #dex-options input[type="checkbox"], #dexpair-options input[type="checkbox"]', function() {
        // Menentukan kategori checkbox berdasarkan ID
        const groupName = $(this).closest('div[id^="cex-options"], div[id^="dex-options"], div[id^="dexpair-options"]').attr('id');
        let selectedValues = [];
        $(`#${groupName} input[type="checkbox"]:checked`).each(function() {
            selectedValues.push($(this).val());
        });

        // Tentukan key lokalStorage berdasarkan groupName
        const localStorageKeyMap = {
            'cex-options': 'CEX_PILIH',
            'dex-options': 'DEX_PILIH',
            'dexpair-options': 'DEXPAIR_PILIH'
        };
        const localStorageKey = localStorageKeyMap[groupName];

        if (localStorageKey) {
            saveToLocalStorage(localStorageKey, selectedValues);  // Simpan ke localStorage
            UIkit.notification(`SETTING APLIKASI ${groupName.toUpperCase()} menjadi ${selectedValues.join(', ')} !`, { status: 'success' });
        }

        // Memanggil fungsi filter dan reload data
        const filteredTokens = filterTokens(selectedValues);  // Pastikan filterTokens menerima nilai yang difilter
       // console.log("TOKEN TERFILTER ",filteredTokens);
        loadStoredData(filteredTokens); 
        
        location.reload()
        // Memuat data yang sudah difilter
    });

    // Fungsi untuk mengurutkan tabel
    function sortTable(columnIndex) {
        const rows = $('#dataTableBody tr').get();

        rows.sort(function(a, b) {
            const keyA = $(a).children('td').eq(columnIndex).text().toUpperCase();
            const keyB = $(b).children('td').eq(columnIndex).text().toUpperCase();

            if (sortOrder[columnIndex] === undefined) {
                sortOrder[columnIndex] = true; // Default ke urutan naik
            }

            if (keyA < keyB) return sortOrder[columnIndex] ? -1 : 1;
            if (keyA > keyB) return sortOrder[columnIndex] ? 1 : -1;
            return 0;
        });

        // Kosongkan tabel dan tambahkan kembali baris yang sudah diurutkan
        $('#dataTableBody').empty().append(rows);

        // Update kolom No agar tetap berurutan
        $('#dataTableBody tr').each((index, row) => {
            $(row).children('td').first().text(index + 1); // Set nomor berurutan
        });

        // Toggle urutan untuk kolom yang sama
        sortOrder[columnIndex] = !sortOrder[columnIndex];
        updateSortIcons();
    }

    // Memperbarui ikon urutan
    function updateSortIcons() {
        $('.sort-icon').html(''); // Reset semua ikon
        for (let index in sortOrder) {
            const icon = sortOrder[index] ? '▲' : '▼';
            $('#sortIcon' + index).html(icon);
        }
    }

    //fungsi generate setting modal untuk DEX
    function generateInputModal(dexList) {
        const container = $('#modal-container');
        container.empty(); // Bersihkan container

        dexList.forEach(dex => {
            const dexUpperCase = dex.toUpperCase();

            // Judul per DEX
            const heading = $('<h5></h5>')
                .css({ 'margin': '8px 0px', 'color': '#e4322c' })
                .text(`Modal ${dexUpperCase}`);
            container.append(heading);

            // Buat wrapper div untuk input kiri dan kanan
            const rowDiv = $('<div></div>').addClass('uk-grid-small').addClass('uk-child-width-1-2').attr('uk-grid', '');

            // Input Modal Kiri
            const leftDiv = $('<div></div>');
            const leftLabel = $('<label></label>').text('Kiri');
            const leftInput = $('<input>')
                .attr('type', 'number')
                .attr('id', `ModalKiri${dexUpperCase}`)
                .addClass('uk-input')
                .val('0')
                .attr('required', true);
            leftDiv.append(leftLabel).append(leftInput);

            // Input Modal Kanan
            const rightDiv = $('<div></div>');
            const rightLabel = $('<label></label>').text('Kanan');
            const rightInput = $('<input>')
                .attr('type', 'number')
                .attr('id', `ModalKanan${dexUpperCase}`)
                .addClass('uk-input')
                .val('0')
                .attr('required', true);
            rightDiv.append(rightLabel).append(rightInput);

            // Gabungkan kiri dan kanan
            rowDiv.append(leftDiv).append(rightDiv);

            // Tambahkan ke container
            container.append(rowDiv);
        });
    }

    function processOrderBook(data) {
        const priceBuy = data.bids.slice(0, 3).map(([price, volume]) => ({
            price: parseFloat(price),
            volume: parseFloat(volume) * parseFloat(price) // Volume dalam USD
        })).reverse(); // Membalik urutan priceBuy

        const priceSell = data.asks.slice(0, 3).map(([price, volume]) => ({
            price: parseFloat(price),
            volume: parseFloat(volume) * parseFloat(price) // Volume dalam USD
        })).reverse(); // Membalik urutan priceSell

        return { priceBuy, priceSell };
    }

    function getRateUSDT() {
        // Ambil harga ETHUSDT dari API Binance
        $.getJSON('https://api.binance.com/api/v3/ticker/price?symbol=ETHUSDT')
            .done(function (response) {
                let ratePrice = {}; // Inisialisasi objek untuk menyimpan harga
                
                // Simpan harga ETH/USDT ke ratePrice
                if (response.price) {
                    ratePrice["eth"] = parseFloat(response.price); // Harga ETH ke USDT
                }
    
                // Ambil harga USDT/IDR dari API Indodax
                $.getJSON('https://indodax.com/api/ticker/usdtidr')
                    .done(function (responseIndodax) {
                        ratePrice["idr"] = parseFloat(responseIndodax.ticker.last); // Harga USDT ke IDR
    
                        // Hitung harga ETH ke IDR
                        if (ratePrice.eth) {
                            saveToLocalStorage('RateIDRETH', ratePrice.eth);
                            saveToLocalStorage('RateETHIDR', ratePrice.eth);
                         //   console.log("RATE ETH/USDT: " + ratePrice.eth.toFixed(2));
                        }
    
                        // Simpan harga USDT ke IDR ke localStorage dan tampilkan di halaman
                        if (ratePrice.idr) {
                            saveToLocalStorage('PriceRateUSDT', ratePrice.idr);
                            console.log("RATE USDT/IDR: " + ratePrice.idr);
                          // $("#rateUSDT").text("RATE USDT/IDR: " + ratePrice.idr);
                        }
                    })
                    .fail(function (error) {
                        console.error("Error fetching USDT/IDR price:", error);
                        toastr.error('KONEKSI INDODAX KENA lIMIT!');
                    });
            })
            .fail(function (error) {
                console.error("Error fetching ETH/USDT price:", error);
                toastr.error('CEK KONEKSI BINANCE ANDA / AKTIFKAN CORS!');
            });
    }

    // list api OKXDEX sell_BINANCE_USDT_buy_0x_BAL
    const apiKeysOKXDEX = [
        
        {
            ApiKeyOKX: "47953eea-d5aa-43f9-9d56-34966978d693",
            secretKeyOKX: "11C0BD3536C759C5A5E5F7A70077A483",
            PassphraseOKX: "2017-Ochiem",
            ProjectOKX: "22747ba1b56f9da3a7c10140cb95ffa5"
        },{
            ApiKeyOKX: "fb673273-7b7e-4857-b30d-316e5600e13c",
            secretKeyOKX: "C6F812C9670DE4327408BB21B09F38BC",
            PassphraseOKX: "2017-Ochiem",
            ProjectOKX: "ebb6d5612181cb993230ca49c7b50cb8"
        },{
            ApiKeyOKX: "6db77592-fb30-466e-ae0e-c7f3ae15ce7c",
            secretKeyOKX: "BAFD1D91B6D359DCB92629FD44852307",
            PassphraseOKX: "2017-Ochiem",
            ProjectOKX: "df27a64d6c0130624609cc5b56c274d0"
        },{
            ApiKeyOKX: "9ed6219f-980c-417a-a544-055c937b4296",
            secretKeyOKX: "17CEA820AF94463DB8AC6AEC283287D0",
            PassphraseOKX: "2017-Ochiem",
            ProjectOKX: "c95a51b2e06febfbe3976621beb95975"
        },{
            ApiKeyOKX: "7540524b-85a7-440b-84e4-f71280ec8919",
            secretKeyOKX: "A992D6F2890740F8509587868C8A37A3",
            PassphraseOKX: "2017-Ochiem",
            ProjectOKX: "55b213a813f3fd8080a209acdc4aec9b"
        },{
            ApiKeyOKX: "46df841b-4e72-4f3f-a91c-1d1a9b315708",
            secretKeyOKX: "DA06455105A85C3F770C6E01AC42F9DA",
            PassphraseOKX: "2017-Ochiem",
            ProjectOKX: "3174e031e2d03982662688a2734d542e"
        },{
            ApiKeyOKX: "3a3e9296-6c13-4562-84d8-7f4824fb7ac7",
            secretKeyOKX: "1DD3C44F3CA652D4478F739E15C84515",
            PassphraseOKX: "2017-Ochiem",
            ProjectOKX: "9c6ae2d2465046deb6e2965b28a07c42"
        },{
            ApiKeyOKX: "d675d069-4054-4932-a8b1-303b981b8124",
            secretKeyOKX: "2D957A6AAFA1DB1D521296FB0D89F151",
            PassphraseOKX: "2017-Ochiem",
            ProjectOKX: "54e89c9d24d9fb531c527661c84f42dc"
        },{
            ApiKeyOKX: "32ecce69-add4-4fda-984e-7cb34a22797f",
            secretKeyOKX: "5FB9974EA1AC161A27DB68BA51531534",
            PassphraseOKX: "2017-Ochiem",
            ProjectOKX: "35379ea55673bc3516eb8026539be558"
        },{
            ApiKeyOKX: "cccd8b36-a09a-4578-9837-48135f0ff230",
            secretKeyOKX: "EEA4E6EE19EBCDB8CD59F52A9FC8B3CD",
            PassphraseOKX: "2017-Ochiem",
            ProjectOKX: "bab376dfe9e2815c5902e7694bed486e"
        },{
            ApiKeyOKX: "8a059b63-002c-471d-b495-5e55b15bf12a",
            secretKeyOKX: "CAC05FFFD91F84230AA5E8BA0E06B172",
            PassphraseOKX: "2017-Ochiem",
            ProjectOKX: "df1bcaf4acca274c769fc170a7f9dcbb"
        },{
            ApiKeyOKX: "75b75f5e-dbd3-4948-a5ce-77af8871e6ac",
            secretKeyOKX: "5D9F841F0B57E8D51DC574EBE487748C",
            PassphraseOKX: "2017-Ochiem",
            ProjectOKX: "ca2ed1bae58cacd15cf1006a933a2c94"
        },{
            ApiKeyOKX: "54aa3296-d6ab-4873-a5bb-b00d2b006015",
            secretKeyOKX: "971AC2D6264E45F895D446D878B55AE4",
            PassphraseOKX: "2017-Ochiem",
            ProjectOKX: "7304207d79c2df4956d5fdd9f1afc2c2"
        },{
            ApiKeyOKX: "3f6b0085-2d3a-4fc0-8917-a555d1cd259c",
            secretKeyOKX: "68A12A595AA5EA5EFC03DDBAD452DBD6",
            PassphraseOKX: "2017-Ochiem",
            ProjectOKX: "591778696ad3438a4266b0bbd6297d2e"
        },{
            ApiKeyOKX: "3b96a61f-68fd-4d4c-94d9-ff357ef2fb83",
            secretKeyOKX: "3E29ED11AF70FCC530C39948BFAA2405",
            PassphraseOKX: "2017-Ochiem",
            ProjectOKX: "0fbd7084efbd79e915f99701aa989c28"
        },{
            ApiKeyOKX: "94e7d78e-708f-48ff-814d-70a1f3e6fd49",
            secretKeyOKX: "2FD013E26D1309B2B532407FFD4BC097",
            PassphraseOKX: "2017-Ochiem",
            ProjectOKX: "8607ef99dc6e31a80e21b16f914a0f18"
        },
       
        
      ];
      
       // Fungsi untuk Signature
    function calculateSignature(exchange, apiSecret, dataToSign, hashMethod = "HmacSHA256") {
        if (!apiSecret || !dataToSign) {
            console.error(`[${exchange}] API Secret atau Data untuk Signature tidak valid!`);
            return null;
        }
    
        switch (exchange.toUpperCase()) {
            case "MEXC":
            case "BINANCE":
            case "KUCOIN":
            case "BYBIT":
                // Gunakan HMAC-SHA256
                return CryptoJS[hashMethod](dataToSign, apiSecret).toString(CryptoJS.enc.Hex);
    
            case "OKX":
                // Gunakan BASE64 untuk OKX
                const hmac = CryptoJS.HmacSHA256(dataToSign, apiSecret);
                return CryptoJS.enc.Base64.stringify(hmac);
    
            default:
                console.error(`[${exchange}] Exchange tidak didukung untuk perhitungan signature.`);
                return null;
        }
    } 
    
      // Fungsi untuk mendapatkan kredensial API secara acak
      function getRandomApiKeyOKX() {
        const randomIndex = Math.floor(Math.random() * apiKeysOKXDEX.length);
        return apiKeysOKXDEX[randomIndex];
      }


    function DisplayPNL(PNL, cex, Coin_in, NameX, totalFee, modal, dex, priceCEX, priceDEX, FeeSwap, FeeWD, sc_input, sc_output, Coin_out, totalValue, totalModal, conclusion, selisih, trx, profitLossPercent, vol) {
        var filterPNLValue = parseFloat(SavedSettingData.filterPNL);
        var nickname = SavedSettingData.nickname;
        var totalValue = parseFloat(totalValue);
        var totalGet = totalValue - parseFloat(modal);
        var totalModal = parseFloat(totalModal);
        var totalFee = parseFloat(totalFee);
        var checkVol = $('#checkVOL').is(':checked');

        const urlsCEXToken = GeturlExchanger(cex.toUpperCase(), Coin_in, Coin_out);
        var buyLink = urlsCEXToken.tradeToken;
        var sellLink = urlsCEXToken.tradePair;
        var IdCELL = `${cex.toUpperCase()}_${dex.toUpperCase()}_${NameX}_${(DTChain.Nama_Chain).toUpperCase()}`;
        var rowCell = $(`#${IdCELL}`);
        var resultCell = $(`#RESULT_${IdCELL}`);
        var buyCell = $(`#LEFT_${IdCELL}`);
        var sellCell = $(`#RIGHT_${IdCELL}`);

        // console.log("PAIR", NameX);   
        // console.log("TRX", trx);            
        // console.log("Vol", vol);
        // console.log("CheckVOL:", checkVol);
        // console.log("PNL:", PNL);
        // console.log("FEE ALL:", totalFee);
        // console.log('------------------------------------');

        var sinyals = `<a href="#SWAP_${cex.toUpperCase()}_${dex.toUpperCase()}_${NameX}_${(DTChain.Nama_Chain).toUpperCase()}" class='link-class'>
            ${cex.toUpperCase()} VS ${dex.toUpperCase()} : ${NameX} (${PNL.toFixed(2)}$)</a>`;

        const isPNLPositive = (filterPNLValue === 0 && totalValue > totalModal) || ((totalValue - totalModal) > filterPNLValue);
        const isVolEnough = parseFloat(vol) >= parseFloat(modal);
        const canHighlight = (!checkVol && isPNLPositive) || (checkVol && isPNLPositive && isVolEnough);

        if (canHighlight) {
            toastr.success(sinyals);
            rowCell.attr("style", "background-color: #daf4c3 !important; font-weight: bolder !important; color: black !important;");

            let htmlFee = '';
            if (trx === "TokentoPair") {
                htmlFee = `<span style="color:#0f04e2 !important;">FeeWD: ${FeeWD.toFixed(2)}$</span> | 
                        ${createLink(urlsCEXToken.withdrawUrl, 'WD')}<br/>`;
            } else if (trx === "PairtoToken") {
                htmlFee = `<span style="color:#0f04e2 !important;">FeeWD: ${FeeWD.toFixed(2)}$</span> | 
                        ${createLink(urlsCEXToken.depositUrl, 'DP')}<br/>`;
            }

            let htmlResult = `
                ${htmlFee}
                <span style="color: #d20000;">All: ${totalFee.toFixed(2)}$</span>
                <span style="color: #1e87f0;">SW: ${FeeSwap.toFixed(2)}$</span><br/>
                <span style="color: #444;">GT: ${totalGet.toFixed(2)}$</span>
                <span style="color: #444;">PNL: ${PNL.toFixed(2)}$</span><br/>
            `;
            resultCell.html(htmlResult);

            if (!buyCell.parent().is("span")) {
                buyCell.wrap('<a href="' + buyLink + '" target="_blank"></a>');
            }
            if (!sellCell.parent().is("span")) {
                sellCell.wrap('<a href="' + sellLink + '" target="_blank"></a>');
            }           

            InfoSinyal(dex.toLowerCase(), NameX, PNL, totalFee, cex.toUpperCase(), Coin_in, Coin_out, profitLossPercent, modal,trx);
            
        } else {
            resultCell.html(`
                <span style="color:black;" title="FEE WD CEX">FeeWD : ${FeeWD.toFixed(2)}$</span><br/>
                <span class="uk-text-danger" title="FEE ALL">ALL:${totalFee.toFixed(2)}$</span>
                <span class="uk-text-primary" title="FEE SWAP"> ${FeeSwap.toFixed(2)}$</span><br/>
                <span class="uk-text-success" title="GET BRUTO">GT:${totalGet.toFixed(2)}$</span>
                <span class="uk-text-warning" title="GET NETTO / PNL" > ${PNL.toFixed(2)}$</span>
            `);
        }

        if (PNL > 1) {
            MultisendMessage(cex, dex.toUpperCase(), Coin_in, Coin_out, modal, PNL, priceCEX, priceDEX, FeeSwap, FeeWD, totalFee, nickname, sc_input, sc_output);
        }

    }

   // Fungsi utama menampilkan sinyal
    function InfoSinyal(DEXPLUS, TokenPair, PNL, totalFee, cex, NameToken, NamePair, profitLossPercent, modal, trx) {
        var warnaCEX = getWarnaCEX(cex);               // warna teks berdasarkan CEX
        var warnaTeksArah = trx === "TokentoPair" ? "uk-text-success" : "uk-text-danger"; // arah transaksi

        let idCELL = `${cex.toUpperCase()}_${DEXPLUS.toUpperCase()}_${NameToken}_${NamePair}_${(DTChain.Nama_Chain).toUpperCase()}`;

        // Blok HTML dengan background khusus
        var sLink = `<div>
            <a href="#${idCELL}" class="buy" style="text-decoration:none;">
                <span style="color:${warnaCEX}; font-weight:bolder;">
                    ~ ${cex.toUpperCase()}<span class="uk-text-secondary">:${modal}</span>
                    <span class="${warnaTeksArah}"> ${NameToken}->${NamePair}</span>:
                    <span class="uk-text-warning">${PNL.toFixed(2)}$</span> <span class="uk-text-secondary">(${profitLossPercent.toFixed(2)}%)</span>
                </span>
            </a>
        </div>`;

        // Tambahkan ke div target sinyal sesuai DEX
        $("#sinyal" + DEXPLUS.toLowerCase()).append(sLink);

        // Suara
        var audio = new Audio('audio.mp3');
        audio.play();
    }

    // ALL Sent TELE
    function sendStatusTELE(user, status) {
        var users = [
            { chat_id: SavedSettingData.ID_GRUP }
        ];

        var token = SavedSettingData.TOKEN;
        var apiUrl = 'https://api.telegram.org/bot' + token + '/sendMessage';

        // Ambil data dari localStorage dan parse sebagai JSON object
        var data = getFromLocalStorage('ID','');
        var pilihDex = getFromLocalStorage('DEX_PILIH', null);
        var pilihCex = getFromLocalStorage('CEX_PILIH', null);
        var dexList = pilihDex ? pilihDex.join(', ') : 'Not Selected';
        var cexList = pilihCex ? pilihCex.join(', ') : 'Not Selected';

        var message = " #" + user.toUpperCase() + " is <b>[ " + status + " ]</b>" +
            "\n ----------------------------------------------------"+
            "\n <b> #FAVORITE 1.7 ~ "+DTChain.Nama_Chain.toUpperCase()+" </b>"+
            "\n <b> CEX: </b>" + cexList.toUpperCase() +
            "\n <b> DEX: </b>" + dexList.toUpperCase() +
            "\n <b> ID UNIX : </b>" + data.id +
            "\n <b> PROVIDER : </b> " + data.name +
            "\n <b> IP : </b>" + data.ip+
            "\n ----------------------------------------------------";
        // Loop melalui daftar pengguna
        for (var i = 0; i < users.length; i++) {
            var user = users[i];
            var chatId = user.chat_id; // Ganti dengan ID chat pengguna

            // Membuat permintaan POST menggunakan jQuery
            $.ajax({
            url: apiUrl,
            method: "POST",
            data: {
                chat_id: chatId,
                text: message,
                parse_mode: "HTML",
                disable_web_page_preview: true
            },
            success: function(response) {
                // console.log("Message sent successfully");
            },
            error: function(xhr, status, error) {
                console.log("Error sending message:", error);
            }
            });
          }
        }
        //sent sinyal kegrup tele
        function MultisendMessage(cex, dex, token, pair, modal, PNL, priceBUY, priceSELL, FeeSwap, FeeWD, totalFee, nickname, sc_in, sc_out) {
            const urlsCEX = GeturlExchanger(cex, token, pair);
            const SavedSettingData = getFromLocalStorage('DATA_SETTING', { ID_GRUP: 0, TOKEN: '' });

            if (!SavedSettingData.TOKEN || !SavedSettingData.ID_GRUP) {
                toastr.error("Token atau ID Grup Telegram tidak tersedia!");
                return;
            }

            let Linksctoken = `<a href="${DTChain.URL_Chain}/token/${sc_in}" target="_blank" class="uk-link">${token}</a>`;
            let Linkscpair = `<a href="${DTChain.URL_Chain}/token/${sc_out}" target="_blank" class="uk-link">${pair}</a>`;
            let linkDEX = `<a href="https://swap.defillama.com/?chain=${DTChain.Nama_Chain}&from=${sc_in}&to=${sc_out}" target="_blank" class="uk-link">${dex}</a>`;
            let linkCEX = urlsCEX && urlsCEX.tradeToken ? `<a href="${urlsCEX.tradeToken}" target="_blank" class="uk-link">${cex}</a>` : `<b>${cex}</b>`;

            let message = 
                `<b>#FAVORITE 1.7 #${DTChain.Nama_Chain.toUpperCase()}</b>\nUSER: ~ ${nickname}\n` +
                `-----------------------------------------\n` +
                `MARKET: ${linkCEX} VS ${linkDEX}\n` +
                `TOKEN-PAIR: <b>#${token}_${pair}</b>\n` +
                `MODAL: <b>${modal}$</b> | PROFIT: <b>${PNL.toFixed(2)}$</b>\n` +
                `<b>BUY ${Linksctoken}:</b> ${priceBUY.toFixed(9)}\n` +
                `<b>SELL ${Linkscpair}:</b> ${priceSELL.toFixed(9)}\n` +
                `<b>FEEWD:</b> ${FeeWD.toFixed(3)}\n` +
                `FEETOTAL: <b>${totalFee.toFixed(2)}$</b> | SWAP: <b>${FeeSwap.toFixed(2)}$</b>\n` +
                `-----------------------------------------`;

           // toastr.info(message);

            // Kirim ke Telegram
            const apiUrl = 'https://api.telegram.org/bot' + SavedSettingData.TOKEN + '/sendMessage';
            $.ajax({
                url: apiUrl,
                method: "POST",
                data: {
                    chat_id: SavedSettingData.ID_GRUP,
                    text: message,
                    parse_mode: "HTML",
                    disable_web_page_preview: true
                },
                success: function () {
                    console.log("Pesan berhasil dikirim ke Telegram");
                },
                error: function (xhr, status, error) {
                    console.error("Gagal kirim pesan:", error);
                    toastr.error("Gagal kirim ke Telegram: " + error);
                }
            });
        }

  
    // Fungsi CekIdentitas untuk mendapatkan ID perangkat
    async function CekIdentitas() {
        try {
            let deviceID = generateDeviceID();
            let response = await fetch('https://api4.my-ip.io/v2/ip.json');
            let data = await response.json();

            let simplifiedIdentitas = {
                id: deviceID,
                name: data.asn.name,
                ip: data.ip
            };

            saveToLocalStorage('ID', simplifiedIdentitas);
            let savedID = getFromLocalStorage('ID', {});
        } catch (error) {
            //toastr.info("GAGAL CEK IP!!");
        }
    }

    // Fungsi generateDeviceID
    function generateDeviceID() {
        let userAgent = navigator.userAgent;
        let screenResolution = `${window.screen.width}x${window.screen.height}`;
        let timezoneOffset = new Date().getTimezoneOffset();
        let language = navigator.language;

        return hashCode(`${userAgent}${screenResolution}${timezoneOffset}${language}`);
    }

    // Fungsi untuk menghasilkan hashCode
    function hashCode(str) {
        return str.split("").reduce((hash, char) => {
            hash = ((hash << 5) - hash) + char.charCodeAt(0);
            return hash & hash;
        }, 0);
    }

    // Fungsi untuk Signature CEX
    function calculateSignature(exchange, apiSecret, dataToSign, hashMethod = "HmacSHA256") {
        if (!apiSecret || !dataToSign) {
            console.error(`[${exchange}] API Secret atau Data untuk Signature tidak valid!`);
            return null;
        }
    
        switch (exchange.toUpperCase()) {
            case "MEXC":
            case "BINANCE":
            case "KUCOIN":
            case "BYBIT":
                // Gunakan HMAC-SHA256
                return CryptoJS[hashMethod](dataToSign, apiSecret).toString(CryptoJS.enc.Hex);
    
            case "OKX":
                // Gunakan BASE64 untuk OKX
                const hmac = CryptoJS.HmacSHA256(dataToSign, apiSecret);
                return CryptoJS.enc.Base64.stringify(hmac);
    
            default:
                console.error(`[${exchange}] Exchange tidak didukung untuk perhitungan signature.`);
                return null;
        }
    }    

    //fungsi download token
    $('#tokenCountALL').on('click', function () {
        // Ambil data dari localStorage
        const rawData = getFromLocalStorage("TOKEN_FAV_SCANNER", []);
        //const rawData = filteredData;
        if (!rawData || rawData.length === 0) {
            toastr.error('Data TOKEN tidak ditemukan...');
            return;
        }

        // Proses data ke format CSV
        const formattedData = rawData.map(item => ({
            cex: item.cex,
            symbol_in: item.symbol_in,
            sc_in: item.sc_in,
            des_in: item.des_in,
            withdrawToken: item.status ? "TRUE" : "FALSE",
            depositToken: item.status ? "TRUE" : "FALSE",
            symbol_out: item.symbol_out,
            sc_out: item.sc_out,
            des_out: item.des_out,
            withdrawPair: item.status ? "TRUE" : "FALSE",
            depositPair: item.status ? "TRUE" : "FALSE",
            status: item.status ? "TRUE" : "FALSE" ,
        }));

        // Buat header dan isi CSV
        const csvHeader = Object.keys(formattedData[0]).join(','); // Header CSV
        const csvRows = formattedData.map(row => Object.values(row).join(',')).join('\n'); // Gabungkan semua baris
        const csvContent = `${csvHeader}\n${csvRows}`; // Gabungkan header dan isi

        // Buat file Blob untuk diunduh
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);

        // Buat elemen <a> untuk download
        const a = document.createElement('a');
        // Hitung jumlah item yang statusnya true
        const countTrueStatus = rawData.filter(item => 
                item.status === true 
                /* && 
                item.depositPair === true && 
                item.withdrawToken === true && 
                item.depositToken === true && 
                item.withdrawPair === true
                */
        ).length;
   
        a.href = url;
        a.download = countTrueStatus+'_MULTISCAN_V1_' + (Nama_Chain || 'UNKNOWN').toUpperCase() + '_TOKEN_FAV.csv'; // Pastikan Nama_Chain terdefinisi
        a.style.display = 'none';

        // Tambahkan tombol ke DOM dan klik
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    });

    function setLastAction(action) {
        const now = new Date();
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const seconds = now.getSeconds().toString().padStart(2, '0');
        const day = now.getDate().toString().padStart(2, '0');
        const month = (now.getMonth() + 1).toString().padStart(2, '0'); // Bulan dimulai dari 0
        const year = now.getFullYear();

        const formattedTime = `${hours}:${minutes}:${seconds} | ${day}/${month}/${year}`;

        const lastAction = {
            time: formattedTime,
            action: action
        };

        saveToLocalStorage("HISTORY", lastAction);
        $("#infoAPP").html(`${lastAction.action} at ${lastAction.time}`);
    }
    
</script>
<script src="https://cdn.jsdelivr.net/npm/uikit@3.6.22/dist/js/uikit.min.js"></script>
</body>
</html>
